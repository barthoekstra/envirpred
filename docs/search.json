[{"path":"index.html","id":"introduction","chapter":"Introduction","heading":"Introduction","text":"","code":""},{"path":"index.html","id":"reproducible-analysis","chapter":"Introduction","heading":"0.1 Reproducible analysis","text":"entire analysis contained book can reproduced running following function bookdown package.may necessary install additional packages make use bs4_book template book.","code":"\nbookdown::render_book(\"index.Rmd\")\ninstall.packages(\"remotes\")\nremotes::install_github(\"rstudio/bslib\")\ninstall.packages(\"downlit\")"},{"path":"gee-harmonic-regression.html","id":"gee-harmonic-regression","chapter":"1 GEE: Harmonic Regression","heading":"1 GEE: Harmonic Regression","text":"project want explore degree environmental predictability can explain species declines among sub-Saharan migrant songbirds. define environmental predictability degree simple harmonic regression model can fit seasonal changes environmental variables wintering areas sub-Saharan migrants.able run harmonic time series analysis fine-scale across full extent wintering ranges birds, use Google Earth Engine (GEE).","code":""},{"path":"gee-harmonic-regression.html","id":"apply-harmonic-regression-to-gee-datasets","chapter":"1 GEE: Harmonic Regression","heading":"1.1 Apply harmonic regression to GEE datasets","text":"function R/rgee_harmonic_regression.R contains code necessary run harmonic regression GEE using rgee package. export harmonic regression results 10km resolution limit spatial domain following area.Obviously area spans much just Africa, interpretation results (possible future expansion analysis include breeding areas), beneficial.can now run harmonic regression GEE generate GeoTIFFs analyses. particularly interested NDVI use temporal range NASA/GIMMS/3GV0 dataset (GEE) determine time frame run analysis.","code":"\naoi <- read_sf(\"data/raw/studyarea.geojson\")\nleaflet(aoi) %>%\n  addProviderTiles(\"CartoDB.Positron\") %>%\n  addPolygons(color = \"black\")\nsource(\"R/rgee_harmonic_regression.R\")\n\nres <- 10000\n\nndvi1 <- rgee_harmonic_regression(dataset = \"NASA/GIMMS/3GV0\", dependent = \"ndvi\", harmonics = 1, \n                                  aoi = aoi, resolution = res, dsn = \"data/raw/gee/ndvi_1.tif\", mask = -1)\nndvi2 <- rgee_harmonic_regression(dataset = \"NASA/GIMMS/3GV0\", dependent = \"ndvi\", harmonics = 2,\n                                  aoi = aoi, resolution = res, dsn = \"data/raw/gee/ndvi_2.tif\", mask = -1)\naet1 <- rgee_harmonic_regression(dataset = \"IDAHO_EPSCOR/TERRACLIMATE\", dependent = \"aet\", harmonics = 1,\n                                 aoi = aoi, resolution = res, dsn = \"data/gee/raw/aet_1.tif\")\naet2 <- rgee_harmonic_regression(dataset = \"IDAHO_EPSCOR/TERRACLIMATE\", dependent = \"aet\", harmonics = 2,\n                                 aoi = aoi, resolution = res, dsn = \"data/gee/raw/aet_2.tif\")\npr1 <- rgee_harmonic_regression(dataset = \"IDAHO_EPSCOR/TERRACLIMATE\", dependent = \"pr\", harmonics = 1,\n                                aoi = aoi, resolution = res, dsn = \"data/gee/raw/pr_1.tif\")\npr2 <- rgee_harmonic_regression(dataset = \"IDAHO_EPSCOR/TERRACLIMATE\", dependent = \"pr\", harmonics = 2,\n                                aoi = aoi, resolution = res, dsn = \"data/gee/raw/pr_2.tif\")\ntmmn1 <- rgee_harmonic_regression(dataset = \"IDAHO_EPSCOR/TERRACLIMATE\", dependent = \"tmmn\", harmonics = 1,\n                                  aoi = aoi, resolution = res, dsn = \"data/gee/raw/tmmn_1.tif\")\ntmmn2 <- rgee_harmonic_regression(dataset = \"IDAHO_EPSCOR/TERRACLIMATE\", dependent = \"tmmn\", harmonics = 2,\n                                  aoi = aoi, resolution = res, dsn = \"data/gee/raw/tmmn_2.tif\")\ntmmx1 <- rgee_harmonic_regression(dataset = \"IDAHO_EPSCOR/TERRACLIMATE\", dependent = \"tmmx\", harmonics = 1,\n                                  aoi = aoi, resolution = res, dsn = \"data/gee/raw/tmmx_1.tif\")\ntmmx2 <- rgee_harmonic_regression(dataset = \"IDAHO_EPSCOR/TERRACLIMATE\", dependent = \"tmmx\", harmonics = 2,\n                                  aoi = aoi, resolution = res, dsn = \"data/gee/raw/tmmx_2.tif\")"},{"path":"preprocess-bird-trends-and-distribution-maps.html","id":"preprocess-bird-trends-and-distribution-maps","chapter":"2 Preprocess bird trends and distribution maps","heading":"2 Preprocess bird trends and distribution maps","text":"","code":""},{"path":"preprocess-bird-trends-and-distribution-maps.html","id":"converting-the-esri-geodatabase","chapter":"2 Preprocess bird trends and distribution maps","heading":"2.1 Converting the ESRI Geodatabase","text":"use BirdLife species distribution maps1 determine extents analyses. data provided ESRI File Geodatabase somehow difficult query due size, convert Geopackage first. file substantially bigger, much quicker query.","code":"\nogr2ogr(\"data/raw/birdlife/BOTW.gdb\", \"data/raw/birdlife/BOTW.gpkg\", f = \"GPKG\", nlt = \"MULTIPOLYGON\", sql = \"SELECT * FROM All_Species\", progress = TRUE)"},{"path":"preprocess-bird-trends-and-distribution-maps.html","id":"load-species-trends","chapter":"2 Preprocess bird trends and distribution maps","heading":"2.2 Load species trends","text":"use species trends derived PECBMS, Pan-European Common Bird Monitoring Scheme, contains trends 179 European breeding birds.","code":"\ncolnames_species <- c(\"euring\", \"species\", \"namenote\", \"trend_long\", \"trend_short\", \"trend_long_slope\",\n                      \"trend_long_se\", \"trend_short_slope\", \"trend_short_se\", \"habitat\", \"common_name\",\n                      \"trend_classification\", \"graphnote\")\ncoltypes_species <- \"ncnnnnnnncccc\"\n\nspecies <- read_delim(\"data/raw/pecbms/pecbms-europe-indicesandtrends-2019.csv\", delim = \";\", \n                      col_names = colnames_species, col_types = coltypes_species, skip = 1)\nhead(species)"},{"path":"preprocess-bird-trends-and-distribution-maps.html","id":"loading-species-traits","chapter":"2 Preprocess bird trends and distribution maps","heading":"2.3 Loading species traits","text":"download dataset life-history characteristics (LHC) Storchová & Hořák.2We can now load dataset extract species name migratory characteristics, can filter latter later.add species trends life-history characteristics single dataframe.can inspect species migration strategy found yet mismatching species name-pairs. species NA values family column.can now manually change scientific names life-history characteristics dataset match PECBMS dataset.join LHC PECBMS datasets.","code":"\nif (!file.exists(\"data/raw/life-history-characteristics/Life-history characteristics of European birds.txt\")) {\n  paths_cache <- dryad_download(\"10.5061/dryad.n6k3n\")[[1]]\n  paths_final <- paste0(\"data/raw/life-history-characteristics/\", basename(paths_cache))\n  \n  if(!dir.exists(\"data/raw/life-history-characteristics\")) {\n    dir.create(\"data/raw/life-history-characteristics\")\n  }\n  file.copy(from = paths_cache, to = paths_final)\n  file.remove(paths_cache)\n}\nlhc <- read_tsv(\"data/raw/life-history-characteristics/Life-history characteristics of European birds.txt\",\n                col_types = cols_only(`Species` = col_character(), `Family` = col_character(),\n                                      `Sedentary` = col_double(), `Facultative migrant` = col_double(),\n                                      `Short distance migrant` = col_double(), `Long distance migrant` = col_double())) %>%\n  rename(species = Species, family = Family, sedentary = Sedentary, facultative = `Facultative migrant`, \n         shortdist = `Short distance migrant`, longdist = `Long distance migrant`) %>%\n  drop_na()\nspecies %>%\n  left_join(lhc, by = c(\"species\" = \"species\")) -> species\nspecies %>%\n  filter(is.na(family)) %>%\n  head()\nname_replacements <-\n  c(\"Ptyonoprogne rupestris\" = \"Hirundo rupestris\",\n    \"Cecropis daurica\" = \"Hirundo daurica\",\n    \"Cyanecula svecica\" = \"Luscinia svecica\",\n    \"Oenanthe pleschanka\" = \"Oenanthe cypriaca\",\n    \"Iduna pallida\" = \"Hippolais pallida\",\n    \"Sylvia melanothorax\" = \"Sylvia melanothorax\",  # Not in LHC dataset\n    \"Poecile palustris\" = \"Parus palustris\",\n    \"Poecile montanus\" = \"Parus montanus\",\n    \"Lophophanes cristatus\" = \"Parus cristatus\",\n    \"Periparus ater\" = \"Parus ater\",\n    \"Cyanistes caeruleus\" = \"Parus caeruleus\",\n    \"Chloris chloris\" = \"Carduelis chloris\",\n    \"Spinus spinus\" = \"Carduelis spinus\",\n    \"Linaria cannabina\" = \"Carduelis cannabina\",\n    \"Acanthis flammea\" = \"Carduelis flammea\",\n    \"Emberiza calandra\" = \"Miliaria calandra\"\n    )\nspeciesnames <- lhc$species\noldnames <- speciesnames\nfor (name in names(name_replacements)) {\n  speciesnames <- replace(speciesnames, which(speciesnames == name), name_replacements[name])\n}\nlhc$species <- speciesnames\nspecies %>%\n  dplyr::select(-colnames(lhc)[!colnames(lhc) %in% c(\"species\")]) %>%\n  left_join(lhc, by = c(\"species\" = \"species\")) %>%\n  drop_na(family) %>%\n  identity() -> species\n\nhead(species)"},{"path":"preprocess-bird-trends-and-distribution-maps.html","id":"select-migratory-species","chapter":"2 Preprocess bird trends and distribution maps","heading":"2.4 Select migratory species","text":"now dataset 169 species, merely interested actually migratory, filter resident facultative migrants.","code":"\nspecies %>%\n  filter(sedentary != 1 & facultative != 1) -> species\n\nhead(species)"},{"path":"preprocess-bird-trends-and-distribution-maps.html","id":"match-names-to-birdlife-taxonomy","chapter":"2 Preprocess bird trends and distribution maps","heading":"2.5 Match names to BirdLife taxonomy","text":"Finally, querying BirdLife distribution maps, match scientific names taxonomy used BirdLife., see species matched tweak manually match BirdLife dataset.tweak species manually.","code":"\nbirdlife_taxonomy <- readxl::read_excel(\"data/raw/birdlife/HBW-BirdLife_List_of_Birds_v4.xlsx\", \n                                        col_names = c(\"family_birdlife\", \"common_name_birdlife\", \"species\", \"iucn_redlist\"))\n\nspecies %>%\n  left_join(birdlife_taxonomy, by = c(\"species\" = \"species\")) -> species\nspecies %>%\n  filter(is.na(family_birdlife)) %>%\n  head()\nname_replacements_birdlife <-\n  c(\"Hirundo daurica\" = \"Cecropis daurica\",\n    \"Luscinia svecica\" = \"Cyanecula svecica\",\n    \"Hippolais pallida\" = \"Iduna pallida\",\n    \"Carduelis spinus\" = \"Spinus spinus\",\n    \"Carduelis flammea\" = \"Acanthis flammea\"\n    )\nspeciesnames <- species$species\noldnames <- speciesnames\nfor (name in names(name_replacements_birdlife)) {\n  speciesnames <- replace(speciesnames, which(speciesnames == name), name_replacements_birdlife[name])\n}\nspecies$species_birdlife <- speciesnames"},{"path":"preprocess-bird-trends-and-distribution-maps.html","id":"querying-distribution-maps","chapter":"2 Preprocess bird trends and distribution maps","heading":"2.6 Querying distribution maps","text":"Now gathered species trends selected migratory species, can query database select corresponding distribution maps. species distributed massive areas, select parts distributions intersect bounding box Africa.can now join datasets save upcoming analysis steps.","code":"\nspecies_query <- str_sub(str_replace_all(toString(paste0(\"SCINAME = '\", species$species_birdlife, \"' OR \")), \" OR , \", \" OR \"),\n                         start = 1, end = -5)\nquery <- paste(\"SELECT * FROM All_Species WHERE (\", species_query, \") AND PRESENCE = 1 AND SEASONAL = 3\", sep = \"\")\n\nafrica <- st_read(\"data/raw/Africa.gpkg\")\n\nogr2ogr(\"data/raw/birdlife/BOTW.gpkg\", \"data/processed/TrendSpecies.gpkg\", sql = query, f = \"GPKG\", nlt = \"MULTIPOLYGON\", progress = TRUE,\n        spat = st_bbox(africa))\nst_read(\"data/processed/TrendSpecies.gpkg\") %>%\n  group_by(SCINAME) %>%\n  summarise(species = SCINAME, geometry = st_union(st_buffer(geom, dist = 0))) %>%\n  distinct(species) %>%\n  left_join(species, by = c(\"species\" = \"species\")) %>%\n  identity() -> trendspecies\n\nsaveRDS(trendspecies, file = \"data/processed/trendspecies.RDS\")"},{"path":"preprocess-bird-trends-and-distribution-maps.html","id":"species-included-in-the-analysis","chapter":"2 Preprocess bird trends and distribution maps","heading":"2.7 Species included in the analysis","text":"Finally following species now included analysis, based distribution ranges migratory behavior.","code":"\nreadRDS(\"data/processed/trendspecies.RDS\") %>% \n  st_drop_geometry() %>%\n  ungroup() %>%\n  dplyr::select(species, common_name_birdlife) %>%\n  rename(`Scientific name` = species, `Common name (BirdLife)` = common_name_birdlife)"},{"path":"species-assemblage-trends.html","id":"species-assemblage-trends","chapter":"3 Species assemblage trends","heading":"3 Species assemblage trends","text":"study follow methodology Beresford et al. 3 calculate assemblage trend across entire study area. assume environmental factors wintering areas (case Africa) play role towards influencing species trends, areas assemblage trends (product individual species trends) higher likely provide beneficial environmental factors vice versa.","code":""},{"path":"species-assemblage-trends.html","id":"calculate-assemblage-trends","chapter":"3 Species assemblage trends","heading":"3.1 Calculate assemblage trends","text":"calculate long- short-term assemblage trends based PECBMS long-term short-term trends. use raster NDVI predictability template project values onto. Additionally, calculate number species occur within assemblages.","code":"\ntrendspecies <- readRDS(\"data/processed/trendspecies.RDS\")\n\ntrend_long_raster <- list()\ntrend_short_raster <- list()\n\ntemplate_raster <- raster::raster(\"data/raw/gee/ndvi_1.tif\")\n\n# Rasterize distribution maps of individual species and assign trend to pixel values\nfor (i in 1:nrow(trendspecies)) {\n  trend_long_raster[[i]] <- fasterize(trendspecies[i, ], raster = template_raster, field = \"trend_long\")\n  trend_short_raster[[i]] <- fasterize(trendspecies[i, ], raster = template_raster, field = \"trend_short\")\n}\n\n# Turn list of rasters into raster bricks for calculations\ntrend_long_raster <- suppressWarnings(brick(trend_long_raster))\ntrend_short_raster <- suppressWarnings(brick(trend_short_raster))\nnames(trend_long_raster) <- trendspecies[, \"species\"]$species\nnames(trend_short_raster) <- trendspecies[, \"species\"]$species\n\n# Calculate assemblage trend\ntrend_long_assemblage <- calc(trend_long_raster, mean, na.rm = TRUE)\ntrend_short_assemblage <- calc(trend_short_raster, mean, na.rm = TRUE)\n\n# Reclassify trends to NA or 1\ntrend_long_counts <- suppressWarnings(reclassify(trend_long_raster, c(-Inf, Inf, 1)))\ntrend_short_counts <- suppressWarnings(reclassify(trend_short_raster, c(-Inf, Inf, 1)))\n\n# Calculate number of species that make up an assemblage\ntrend_long_counts <- calc(trend_long_counts, sum, na.rm = TRUE)\ntrend_short_counts <- calc(trend_short_counts, sum, na.rm = TRUE)\n\n# Write rasters to files\nwriteRaster(trend_long_assemblage, file = \"data/processed/trend_long_assemblage.tif\", overwrite = TRUE)\nwriteRaster(trend_short_assemblage, file = \"data/processed/trend_short_assemblage.tif\", overwrite = TRUE)\nwriteRaster(trend_long_counts, file = \"data/processed/trend_long_counts.tif\", overwrite = TRUE)\nwriteRaster(trend_short_counts, file = \"data/processed/trend_short_counts.tif\", overwrite = TRUE)"},{"path":"species-assemblage-trends.html","id":"plot-assemblage-trends","chapter":"3 Species assemblage trends","heading":"3.2 Plot assemblage trends","text":"Let’s make quick plot assemblage trends side side","code":"\npar(mfrow = c(1, 2))\nplot(trend_long_assemblage, main = \"Long-term assemblage trend\")\nplot(trend_short_assemblage, main = \"Short-term assemblage trend\")\npar(mfrow = c(1, 2))\nplot(trend_long_counts, main = \"# spp. in long-term assemblage\")\nplot(trend_short_counts, main = \"# spp. in short-term assemblage\")"},{"path":"environmental-predictability-trends.html","id":"environmental-predictability-trends","chapter":"4 Environmental predictability & trends","heading":"4 Environmental predictability & trends","text":"applied harmonic regression datasets containing following variables:NDVI Normalized Difference Vegetation Index GIMMS NDVI AVHRR Sensors 3rd Generation datasetAET Actual Evapotranspiration TerraClimate datasetPR Precipitation accumulation TerraClimate datasetTMMX Maximum temperature TerraClimate datasetTMMN Minimum temperature TerraClimate datasetAll datasets contain monthly aggregates.","code":""},{"path":"environmental-predictability-trends.html","id":"combine-environmental-datasets-and-trend-datasets","chapter":"4 Environmental predictability & trends","heading":"4.1 Combine environmental datasets and trend datasets","text":"need combine predictors (environmental factors) response (assemblage trends) single dataset modelling. also limit data spatially outline African continent (including Madagascar).confirm worked, let’s plot output.","code":"\nafrica_outline <- st_read(\"data/raw/Africa.gpkg\")\n\nload_raster <- function(rasterpath, bandnames) {\n  r <- stack(rasterpath)\n  band_ids <- which(names(r) %in% bandnames)\n  lapply(band_ids, function(x) raster(rasterpath, band = x))\n}\n\nndvi <- load_raster(\"data/raw/gee/ndvi_1.tif\", c(\"residuals\", \"slope\"))\npr <- load_raster(\"data/raw/gee/pr_1.tif\", c(\"residuals\", \"slope\"))\naet <- load_raster(\"data/raw/gee/aet_1.tif\", c(\"residuals\", \"slope\"))\ntmmn <- load_raster(\"data/raw/gee/tmmn_1.tif\", c(\"residuals\", \"slope\"))\ntmmx <- load_raster(\"data/raw/gee/tmmx_1.tif\", c(\"residuals\", \"slope\"))\n\ntrend_long_assemblage <- raster::raster(\"data/processed/trend_long_assemblage.tif\")\ntrend_short_assemblage <- raster::raster(\"data/processed/trend_short_assemblage.tif\")\ntrend_long_counts <- raster::raster(\"data/processed/trend_long_counts.tif\")\ntrend_short_counts <- raster::raster(\"data/processed/trend_short_counts.tif\")\n\ndata <- brick(c(ndvi, pr, aet, tmmn, tmmx, trend_long_assemblage, trend_short_assemblage, trend_long_counts, trend_short_counts))\nnames(data) <- c(\"ndvi_resid\", \"ndvi_trend\", \"pr_resid\", \"pr_trend\", \"aet_resid\", \"aet_trend\", \n                 \"tmmn_resid\", \"tmmn_trend\", \"tmmx_resid\", \"tmmx_trend\", \"trend_long\", \"trend_short\", \"count_long\", \"count_short\")\n\ndata_stars <- st_as_stars(data)[africa]## although coordinates are longitude/latitude, st_intersects assumes that they are planar## Reading layer `Africa-Dissolved' from data source `/mnt/envirpred/raw/Africa.gpkg' using driver `GPKG'\n## Simple feature collection with 1 feature and 2 fields\n## geometry type:  MULTIPOLYGON\n## dimension:      XY\n## bbox:           xmin: -25.3618 ymin: -50.01889 xmax: 77.60327 ymax: 37.55986\n## CRS:            4326\nplot(data_stars)"},{"path":"environmental-predictability-trends.html","id":"save-modeling-dataset","chapter":"4 Environmental predictability & trends","heading":"4.2 Save modeling dataset","text":"now save stars brick dataframe modeling.","code":"\nsaveRDS(data_stars, file = \"data/processed/data_stars.RDS\")\n\nas.data.frame(data_stars) %>%\n  `colnames<-`(c(\"x\", \"y\", \"variable\", \"value\")) %>%\n  pivot_wider(names_from = variable, values_from = value) %>%\n  drop_na() %>%\n  identity() -> data\n\nsaveRDS(data, file = \"data/processed/data.RDS\")"},{"path":"references.html","id":"references","chapter":"5 References","heading":"5 References","text":"1. Bird species distribution maps world. Version 2019.1 (2019).2. Storchová, L., Hořák, D. (2018). Life-history characteristics european birds. Global Ecology Biogeography 27, 400–406.3. Beresford, .E., Sanderson, F.J., Donald, P.F., Burfield, .J., Butler, ., Vickery, J.., Buchanan, G.M. (2018). Phenology climate change africa decline afro-palearctic migratory bird populations. Remote Sensing Ecology Conservation 5, 55–69.","code":""}]
