<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>6 Model assemblage trends | Environmental predictability &amp; Population trends</title>
<meta name="author" content="Bart Hoekstra">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.5.1/jquery-3.5.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.5.3/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.5.3/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.3.9000/tabs.js"></script><script src="libs/bs3compat-0.2.3.9000/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS -->
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="Linking environmental predictability to assemblage population trends of Afro-Palearctic migrants">Environmental predictability &amp; Population trends</a>:
        <small class="text-muted">Linking environmental predictability to assemblage population trends of Afro-Palearctic migrants</small>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Introduction</a></li>
<li class="book-part">Data Preparation</li>
<li><a class="" href="gee-harmonic-regression.html"><span class="header-section-number">1</span> GEE: Harmonic Regression</a></li>
<li><a class="" href="preprocess-bird-trends-and-distribution-maps.html"><span class="header-section-number">2</span> Preprocess bird trends and distribution maps</a></li>
<li><a class="" href="species-assemblage-trends.html"><span class="header-section-number">3</span> Species assemblage trends</a></li>
<li><a class="" href="ecoregions-biomes.html"><span class="header-section-number">4</span> Ecoregions &amp; Biomes</a></li>
<li><a class="" href="environmental-predictability-trends.html"><span class="header-section-number">5</span> Environmental predictability &amp; trends</a></li>
<li class="book-part">Analysis: Global model</li>
<li><a class="active" href="model-assemblage-trends.html"><span class="header-section-number">6</span> Model assemblage trends</a></li>
<li><a class="" href="quantify-model-uncertainty.html"><span class="header-section-number">7</span> Quantify model uncertainty</a></li>
<li class="book-part">Analysis: Local model</li>
<li><a class="" href="model-local-assemblage-trends.html"><span class="header-section-number">8</span> Model local assemblage trends</a></li>
<li class="book-part">Figures</li>
<li><a class="" href="environmental-variables.html"><span class="header-section-number">9</span> Environmental variables</a></li>
<li><a class="" href="trends-variability-method.html"><span class="header-section-number">10</span> Trends-Variability method</a></li>
<li class="book-part">Other</li>
<li><a class="" href="references.html"><span class="header-section-number">11</span> References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/barthoekstra/envirpred">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="model-assemblage-trends" class="section level1">
<h1>
<span class="header-section-number">6</span> Model assemblage trends<a class="anchor" aria-label="anchor" href="#model-assemblage-trends"><i class="fas fa-link"></i></a>
</h1>
<p>In previous chapters we have prepared a dataset for modelling, which we can now start to use.</p>
<div id="correlation-among-predictors" class="section level2">
<h2>
<span class="header-section-number">6.1</span> Correlation among predictors<a class="anchor" aria-label="anchor" href="#correlation-among-predictors"><i class="fas fa-link"></i></a>
</h2>
<p>We first assess correlations among predictors. As we also intend to compare models using environmental predictability with those of long-term trends we separate the correlation matrices for both.</p>
<div id="pearsons-correlation-matrix" class="section level3">
<h3>
<span class="header-section-number">6.1.1</span> Pearson’s correlation matrix<a class="anchor" aria-label="anchor" href="#pearsons-correlation-matrix"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">unused_predictors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"count_long"</span>, <span class="st">"count_short"</span>,
                       <span class="st">"def"</span>, <span class="st">"tmmx"</span>, <span class="st">"tmmn"</span>, <span class="st">"aet"</span>, <span class="st">"pet"</span>, <span class="st">"pr"</span>, <span class="st">"ndvi"</span>, <span class="st">"x"</span>, <span class="st">"y"</span>,
                       <span class="va">lut</span><span class="op">$</span><span class="va">ecoregions</span>, <span class="va">lut</span><span class="op">$</span><span class="va">biomes</span>, <span class="va">lut</span><span class="op">$</span><span class="va">realms</span><span class="op">)</span>
<span class="va">predictors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">%in%</span> <span class="va">unused_predictors</span><span class="op">]</span>
<span class="va">predictors_trends</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"trend_long"</span>, <span class="st">"trend_short"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">data</span>, <span class="fu">ends_with</span><span class="op">(</span><span class="st">"_trend"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">predictors_resids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"trend_long"</span>, <span class="st">"trend_short"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">data</span>, <span class="fu">ends_with</span><span class="op">(</span><span class="st">"_resid"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">predictors_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">predictors_trends</span>, <span class="va">predictors_resids</span><span class="op">)</span>

<span class="fu">ggcorrmat</span><span class="op">(</span><span class="va">data</span>, cor.vars <span class="op">=</span> <span class="fu">all_of</span><span class="op">(</span><span class="va">predictors_trends</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"parametric"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="06.Model-assemblage-trends_files/figure-html/pearson_correlation_matrix-1.png" width="100%"></div>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggcorrmat</span><span class="op">(</span><span class="va">data</span>, cor.vars <span class="op">=</span> <span class="fu">all_of</span><span class="op">(</span><span class="va">predictors_resids</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"parametric"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="06.Model-assemblage-trends_files/figure-html/pearson_correlation_matrix-2.png" width="100%"></div>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggcorrmat</span><span class="op">(</span><span class="va">data</span>, cor.vars <span class="op">=</span> <span class="fu">all_of</span><span class="op">(</span><span class="va">predictors_all</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"parametric"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="06.Model-assemblage-trends_files/figure-html/pearson_correlation_matrix-3.png" width="100%"></div>
<p>This indicates environmental residuals are generally correlated more strongly than long-term trends. Of the covariates, <code>def</code>, <code>tmmx</code> and <code>tmmn</code> are most strongly correlated with each other or other variables. We can reduce correlation for temperature measures by calculating the average temperature from both <code>tmmx</code> and <code>tmmn</code> and will remove <code>def</code> from our modeling dataset.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>tm_resid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowMeans</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">tmmn_resid</span>, <span class="va">tmmx_resid</span><span class="op">)</span><span class="op">)</span>,
         tm_trend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowMeans</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">tmmn_trend</span>, <span class="va">tmmx_trend</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/identity.html">identity</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">data</span>
<span class="va">predictors_trends</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">predictors_trends</span><span class="op">[</span><span class="op">!</span><span class="va">predictors_trends</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"tmmx_trend"</span>, <span class="st">"tmmn_trend"</span>, <span class="st">"def_trend"</span><span class="op">)</span><span class="op">]</span>, <span class="st">"tm_trend"</span><span class="op">)</span>
<span class="va">predictors_resids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">predictors_resids</span><span class="op">[</span><span class="op">!</span><span class="va">predictors_resids</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"tmmx_resid"</span>, <span class="st">"tmmn_resid"</span>, <span class="st">"def_resid"</span><span class="op">)</span><span class="op">]</span>, <span class="st">"tm_resid"</span><span class="op">)</span>
<span class="va">predictors_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">predictors_trends</span>, <span class="va">predictors_resids</span><span class="op">)</span></code></pre></div>
<p>And we calculate a new correlation matrix.</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggcorrmat</span><span class="op">(</span><span class="va">data</span>, cor.vars <span class="op">=</span> <span class="fu">all_of</span><span class="op">(</span><span class="va">predictors_trends</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"parametric"</span>, maxtrix.type <span class="op">=</span> <span class="st">"upper"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="06.Model-assemblage-trends_files/figure-html/calculate_new_correlation_matrix-1.png" width="672"></div>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggcorrmat</span><span class="op">(</span><span class="va">data</span>, cor.vars <span class="op">=</span> <span class="fu">all_of</span><span class="op">(</span><span class="va">predictors_resids</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"parametric"</span>, maxtrix.type <span class="op">=</span> <span class="st">"upper"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="06.Model-assemblage-trends_files/figure-html/calculate_new_correlation_matrix-2.png" width="672"></div>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggcorrmat</span><span class="op">(</span><span class="va">data</span>, cor.vars <span class="op">=</span> <span class="fu">all_of</span><span class="op">(</span><span class="va">predictors_all</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"parametric"</span>, maxtrix.type <span class="op">=</span> <span class="st">"upper"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="06.Model-assemblage-trends_files/figure-html/calculate_new_correlation_matrix-3.png" width="672"></div>
<p>Let’s calculate how trends and variability of the same variable are correlated.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggcorrmat</span><span class="op">(</span><span class="va">data</span>, cor.vars <span class="op">=</span> <span class="fu">all_of</span><span class="op">(</span><span class="va">predictors_all</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"parametric"</span>, output <span class="op">=</span> <span class="st">"dataframe"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">rowwise</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>var1 <span class="op">=</span> <span class="fu">str_split</span><span class="op">(</span><span class="va">parameter1</span>, <span class="st">"_"</span>, simplify <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,
         var2 <span class="op">=</span> <span class="fu">str_split</span><span class="op">(</span><span class="va">parameter2</span>, <span class="st">"_"</span>, simplify <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">var1</span> <span class="op">==</span> <span class="va">var2</span>, <span class="va">var1</span> <span class="op">!=</span> <span class="st">"trend"</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">corr_trend_var</span>

<span class="va">corr_trend_var</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"parameter1"</span>, <span class="st">"parameter2"</span>, <span class="st">"r"</span>, <span class="st">"ci_low"</span>, <span class="st">"ci_high"</span>, <span class="st">"p"</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<div class="kable-table">
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th align="left">parameter1</th>
<th align="left">parameter2</th>
<th align="right">r</th>
<th align="right">ci_low</th>
<th align="right">ci_high</th>
<th align="right">p</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">ndvi_trend</td>
<td align="left">ndvi_resid</td>
<td align="right">0.2932629</td>
<td align="right">0.2900672</td>
<td align="right">0.2964521</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">pr_trend</td>
<td align="left">pr_resid</td>
<td align="right">0.2207327</td>
<td align="right">0.2174075</td>
<td align="right">0.2240529</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">pet_trend</td>
<td align="left">pet_resid</td>
<td align="right">-0.1890657</td>
<td align="right">-0.1924315</td>
<td align="right">-0.1856955</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">aet_trend</td>
<td align="left">aet_resid</td>
<td align="right">0.2944051</td>
<td align="right">0.2912117</td>
<td align="right">0.2975920</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">tm_trend</td>
<td align="left">tm_resid</td>
<td align="right">0.2422414</td>
<td align="right">0.2389507</td>
<td align="right">0.2455266</td>
<td align="right">0</td>
</tr>
</tbody>
</table></div>
</div>
<p>So, clearly, these are only weakly positively correlated, with the exception of <code>pet</code> potential evapotranspiration. The mean Pearson’s r for the correlation between environmental trends and respective variability is only 0.1723153.</p>
<p>We continue to see strong correlation between <code>pr_resid</code> and <code>ndvi_resid</code>, but Pearson correlation coefficients are &lt; 0.7, and as both original variables (<code>ndvi</code> and <code>pr</code>) are effectively uncorrelated in <code>ndvi_trend</code> and <code>pr_trend</code> and we want the trends and predictability model to be comparable, we keep both in.</p>
</div>
</div>
<div id="pairplot" class="section level2">
<h2>
<span class="header-section-number">6.2</span> Pairplot<a class="anchor" aria-label="anchor" href="#pairplot"><i class="fas fa-link"></i></a>
</h2>
<p>While we’re at it, it’s useful to make a pairplot of all predictor variables.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span>
<span class="va">data</span> <span class="op">%&gt;%</span>
  <span class="fu">slice_sample</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">data_tiny</span>

<span class="fu">ggpairs</span><span class="op">(</span><span class="va">data_tiny</span>, columns <span class="op">=</span> <span class="fu">all_of</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">predictors_trends</span><span class="op">)</span><span class="op">)</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="06.Model-assemblage-trends_files/figure-html/data_pairplot-1.png" width="100%"></div>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggpairs</span><span class="op">(</span><span class="va">data_tiny</span>, columns <span class="op">=</span> <span class="fu">all_of</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">predictors_resids</span><span class="op">)</span><span class="op">)</span>, progress <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="06.Model-assemblage-trends_files/figure-html/data_pairplot-2.png" width="100%"></div>
</div>
<div id="optimal-dataset-size" class="section level2">
<h2>
<span class="header-section-number">6.3</span> Optimal dataset size<a class="anchor" aria-label="anchor" href="#optimal-dataset-size"><i class="fas fa-link"></i></a>
</h2>
<p>The current dataset contains 314868 rows of data, which is quite large for fast and efficient ML workflows. We will first determine how the performance of a few suitable learners depends on dataset size and then determine an optimal balance between model performance and dataset size. In other words, we determine at what point increasing the dataset size (the resampled fraction) does not improve the model performance substantially anymore. Rather than optimizing this in several steps, we will tune the hyperparameter <code>subsample.frac</code> by constructing a <code>GraphLearner</code> objects in an <code>mlr3</code> pipeline which tunes dataset size. The following chunk implements this procedure. As it may take very long to run, it’s more convenient to run it only when strictly necessary from the <code>R/hyperparm_subsample_frac.R</code> file. As we can use this procedure to test suitable ML learners, we use <code><a href="https://rdrr.io/pkg/mboost/man/gamboost.html">mboost::gamboost</a></code>, <code><a href="https://rdrr.io/pkg/gbm/man/gbm.html">gbm::gbm</a></code> and <code><a href="https://rdrr.io/pkg/xgboost/man/xgb.train.html">xgboost::xgboost</a></code> learners in our <code>GraphLearner</code>.</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">task</span> <span class="op">&lt;-</span> <span class="va">TaskRegrST</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>id <span class="op">=</span> <span class="st">"data"</span>, backend <span class="op">=</span> <span class="va">data</span>, target <span class="op">=</span> <span class="st">"trend_long"</span>, extra_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>coordinate_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">task</span><span class="op">$</span><span class="fu">select</span><span class="op">(</span><span class="fu">all_of</span><span class="op">(</span><span class="va">predictors</span><span class="op">)</span><span class="op">)</span>

<span class="va">learners</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  <span class="fu">lrn</span><span class="op">(</span><span class="st">"regr.gamboost"</span>, id <span class="op">=</span> <span class="st">"gamboost"</span><span class="op">)</span>,
  <span class="fu">lrn</span><span class="op">(</span><span class="st">"regr.gbm"</span>, id <span class="op">=</span> <span class="st">"gbm"</span><span class="op">)</span>,
  <span class="fu">lrn</span><span class="op">(</span><span class="st">"regr.xgboost"</span>, id <span class="op">=</span> <span class="st">"xgboost"</span><span class="op">)</span>
<span class="op">)</span>
<span class="va">learners_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">learners</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>

<span class="va">gr_subsample</span> <span class="op">&lt;-</span> <span class="fu">po</span><span class="op">(</span><span class="st">"subsample"</span><span class="op">)</span> <span class="op">%&gt;&gt;%</span>
  <span class="fu">po</span><span class="op">(</span><span class="st">"branch"</span>, options <span class="op">=</span> <span class="va">learners_ids</span><span class="op">)</span> <span class="op">%&gt;&gt;%</span>
  <span class="fu">gunion</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">learners</span>, <span class="va">po</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;&gt;%</span>
  <span class="fu">po</span><span class="op">(</span><span class="st">"unbranch"</span><span class="op">)</span>

<span class="va">grlrn_subsample</span> <span class="op">&lt;-</span> <span class="va">GraphLearner</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">gr_subsample</span><span class="op">)</span>

<span class="va">min_nrows</span> <span class="op">&lt;-</span> <span class="fl">100</span>
<span class="va">max_nrows</span> <span class="op">&lt;-</span> <span class="fl">50000</span>

<span class="va">min_nrows_s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="va">min_nrows</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>
<span class="va">max_nrow_s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="va">max_nrows</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>

<span class="va">ps_subsample</span> <span class="op">&lt;-</span> <span class="va">ParamSet</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  <span class="va">ParamDbl</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="st">"subsample.frac"</span>, lower <span class="op">=</span> <span class="va">min_nrows_s</span>, upper <span class="op">=</span> <span class="va">max_nrow_s</span><span class="op">)</span>,
  <span class="va">ParamFct</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="st">"branch.selection"</span>, levels <span class="op">=</span> <span class="va">learners_ids</span><span class="op">)</span>
<span class="op">)</span><span class="op">)</span>

<span class="co"># Distribution of subsample.frac in grid can be visualised as follows</span>
<span class="co"># x &lt;- seq(from = min_nrows_s, to = max_nrow_s, length.out = 20)</span>
<span class="co"># y &lt;- 2^x</span>
<span class="co"># plot(x, y)</span>
<span class="co"># Beware: division by nrow(data) has to be hard-coded in the function below, somehow...</span>

<span class="va">ps_subsample</span><span class="op">$</span><span class="va">trafo</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">param_set</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">x</span><span class="op">$</span><span class="va">subsample.frac</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">2</span><span class="op">^</span><span class="va">x</span><span class="op">$</span><span class="va">subsample.frac</span><span class="op">)</span> <span class="op">/</span> <span class="fl">314868</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">resample_inner</span> <span class="op">&lt;-</span> <span class="fu">rsmp</span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>
<span class="va">resample_outer</span> <span class="op">&lt;-</span> <span class="fu">rsmp</span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>
<span class="va">measure</span> <span class="op">&lt;-</span> <span class="fu">msr</span><span class="op">(</span><span class="st">"regr.rmse"</span><span class="op">)</span>
<span class="va">terminator</span> <span class="op">&lt;-</span> <span class="fu">trm</span><span class="op">(</span><span class="st">"none"</span><span class="op">)</span>
<span class="va">tuner</span> <span class="op">&lt;-</span> <span class="fu">tnr</span><span class="op">(</span><span class="st">"grid_search"</span>, resolution <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>

<span class="va">at</span> <span class="op">&lt;-</span> <span class="va">AutoTuner</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  learner <span class="op">=</span> <span class="va">grlrn_subsample</span>,
  resampling <span class="op">=</span> <span class="va">resample_inner</span>,
  measure <span class="op">=</span> <span class="va">measure</span>,
  search_space <span class="op">=</span> <span class="va">ps_subsample</span>,
  terminator <span class="op">=</span> <span class="va">terminator</span>,
  tuner <span class="op">=</span> <span class="va">tuner</span>,
  store_tuning_instance <span class="op">=</span> <span class="cn">TRUE</span>,
  store_benchmark_result <span class="op">=</span> <span class="cn">TRUE</span>
<span class="op">)</span>

<span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/future/man/plan.html">plan</a></span><span class="op">(</span><span class="st">"multisession"</span>, workers <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
<span class="va">rr</span> <span class="op">&lt;-</span> <span class="fu">resample</span><span class="op">(</span>task <span class="op">=</span> <span class="va">task</span>, learner <span class="op">=</span> <span class="va">at</span>, resampling <span class="op">=</span> <span class="va">resample_outer</span>, store_models <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="fu">as.data.table</span><span class="op">(</span><span class="va">rr</span><span class="op">)</span>, file <span class="op">=</span> <span class="st">"data/processed/rr_dataset_size.RDS"</span><span class="op">)</span>

<span class="va">rr_data</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">rr</span><span class="op">$</span><span class="va">learners</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">model</span><span class="op">$</span><span class="va">tuning_instance</span><span class="op">$</span><span class="va">archive</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">rr_data</span>, file <span class="op">=</span> <span class="st">"data/processed/rr_dataset_size_df.RDS"</span><span class="op">)</span></code></pre></div>
<p>We can now plot the results of the previous workflow and see how cross-validated model performance depends on the subsampled size of the training dataset.</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html">exists</a></span><span class="op">(</span><span class="st">"rr_data"</span><span class="op">)</span><span class="op">)</span> <span class="va">rr_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/processed/rr_dataset_size_df.RDS"</span><span class="op">)</span>

<span class="va">rr_data</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">branch.selection</span>, <span class="va">subsample.frac</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise</span><span class="op">(</span>mean_rmse <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">regr.rmse</span><span class="op">)</span>,
            q05 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">regr.rmse</span>, <span class="fl">0.05</span><span class="op">)</span>,
            q95 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">regr.rmse</span>, <span class="fl">0.95</span><span class="op">)</span>,
            .groups <span class="op">=</span> <span class="st">"drop_last"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>nrows <span class="op">=</span> <span class="fl">2</span><span class="op">^</span><span class="va">subsample.frac</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">rename</span><span class="op">(</span>Learner <span class="op">=</span> <span class="va">branch.selection</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">Learner</span>, fill <span class="op">=</span> <span class="va">Learner</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_path</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">nrows</span>, y <span class="op">=</span> <span class="va">mean_rmse</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_ribbon</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">nrows</span>, ymin <span class="op">=</span> <span class="va">q05</span>, ymax <span class="op">=</span> <span class="va">q95</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_x_continuous</span><span class="op">(</span>trans <span class="op">=</span> <span class="st">"log10"</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">500</span>, <span class="fl">1000</span>, <span class="fl">5000</span>, <span class="fl">10000</span>, <span class="fl">50000</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Subsample size (# rows)"</span>, y <span class="op">=</span> <span class="st">"Model RMSE"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="06.Model-assemblage-trends_files/figure-html/plot_model_rmse_subsample_size-1.png" width="672"></div>
<p>It is clear beyond 10,000 rows performance only continues to improve marginally for untuned <code>xgboost</code> learners and model improvement for the other learners has clearly hit a plateau. So, we can stick to resampling 10,000 rows from the 314868 rows in the original dataframe for our continued statistical modelling.</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nrow_subsample</span> <span class="op">&lt;-</span> <span class="fl">10000</span></code></pre></div>
</div>
<div id="modeling-assemblage-trends" class="section level2">
<h2>
<span class="header-section-number">6.4</span> Modeling assemblage trends<a class="anchor" aria-label="anchor" href="#modeling-assemblage-trends"><i class="fas fa-link"></i></a>
</h2>
<p>We can now finally start to model long-term assemblage trends using a 10^{4}-row subsample of the original dataset. We use a <code>gamboost</code> model as it strikes a balance between predictive accuracy and interpretability, without introducing a lot of ‘jaggedness’ of boosted regression trees (e.g. from <code>gbm</code> and <code>xgboost</code>) that hamper interpretability to those unfamiliar with the data.</p>
<div id="data-filtering" class="section level3">
<h3>
<span class="header-section-number">6.4.1</span> Data filtering<a class="anchor" aria-label="anchor" href="#data-filtering"><i class="fas fa-link"></i></a>
</h3>
<p>Exploratory modeling showed that model errors are largest in the Sahara. As only few species included in our assemblage trends inhabit this area, the assemblage trend is also least reliable (i.e. it is composed of population trends of few species). It thus makes sense to exclude these areas. We set a minimum number of species that contribute to an assemblage trend to <code>&gt;5</code> and limit our analysis strictly to the areas south of the Sahara, which is the <code>Afrotropic</code> realm in our ecoregion dataset. To illustrate this, let’s plot the number of species that are included in the assemblage trends.</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span>
<span class="va">data</span> <span class="op">%&gt;%</span>
  <span class="fu">slice_sample</span><span class="op">(</span>n <span class="op">=</span> <span class="va">nrow_subsample</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>included <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="op">(</span><span class="va">count_long</span> <span class="op">&gt;</span> <span class="fl">5</span> <span class="op">&amp;</span> <span class="va">Afrotropic</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">data_subset</span>

<span class="va">xlim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">20</span>, <span class="fl">60</span><span class="op">)</span>
<span class="va">ylim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">40</span>, <span class="fl">40</span><span class="op">)</span>
<span class="va">clim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">data_subset</span><span class="op">$</span><span class="va">count_long</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">data_subset</span><span class="op">$</span><span class="va">count_long</span><span class="op">)</span><span class="op">)</span>

<span class="fu">ggplot</span><span class="op">(</span><span class="va">data_subset</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, color <span class="op">=</span> <span class="va">count_long</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_color_viridis_c</span><span class="op">(</span>limits <span class="op">=</span> <span class="va">clim</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>subtitle <span class="op">=</span> <span class="st">"Original data"</span>,
       x <span class="op">=</span> <span class="st">"Longitude"</span>, y <span class="op">=</span> <span class="st">"Latitude"</span>, color <span class="op">=</span> <span class="st">"# species"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">coord_fixed</span><span class="op">(</span>xlim <span class="op">=</span> <span class="va">xlim</span>, ylim <span class="op">=</span> <span class="va">ylim</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">original</span>

<span class="va">data_subset</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">included</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, color <span class="op">=</span> <span class="va">count_long</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_color_viridis_c</span><span class="op">(</span>limits <span class="op">=</span> <span class="va">clim</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>subtitle <span class="op">=</span> <span class="st">"Filtered data"</span>,
       x <span class="op">=</span> <span class="st">"Longitude"</span>, y <span class="op">=</span> <span class="st">"Latitude"</span>, color <span class="op">=</span> <span class="st">"# species"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">coord_fixed</span><span class="op">(</span>xlim <span class="op">=</span> <span class="va">xlim</span>, ylim <span class="op">=</span> <span class="va">ylim</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">filtered</span>

<span class="va">original</span> <span class="op">+</span> <span class="va">filtered</span> <span class="op">+</span> <span class="fu">plot_annotation</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Species in long-term assemblage trend"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">plot_layout</span><span class="op">(</span>guides <span class="op">=</span> <span class="st">"collect"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="06.Model-assemblage-trends_files/figure-html/filter_dataset_by_species_count-1.png" width="100%"></div>
</div>
<div id="training-boosted-gams" class="section level3">
<h3>
<span class="header-section-number">6.4.2</span> Training boosted GAMs<a class="anchor" aria-label="anchor" href="#training-boosted-gams"><i class="fas fa-link"></i></a>
</h3>
<p>The training of boosted GAMs (implemented in <code>mboost</code>) will go as follows:</p>
<ol style="list-style-type: decimal">
<li>We train models predicting long term assemblage trends using long-term (linear) trends in environmental predictors and environmental predictability (model residuals from harmonic regression).</li>
<li>We then determine the optimal number of boosting iterations using 10-fold cross-validation, as implemented in the <code>cvrisk</code> function, varying the number of boosts between 250 and 30000.</li>
<li>We calculate the autocovariate of the residuals to correct for (strong) effects of spatial autocorrelation,<span class="citation"><sup><a href="references.html#ref-crase2012" role="doc-biblioref">4</a></sup></span> which violates the independence assumption of regression.</li>
<li>We retrain the model but now whilst including the residual autocovariate as a parameter.</li>
<li>We, once again, determine the optimal number of boosting iterations on the new models. Most likely this does not differ substantially from the previous optimum, but it is good to make sure that is the case.</li>
</ol>
<p>Let’s start with training the models.</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span>
<span class="va">data</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">count_long</span> <span class="op">&gt;</span> <span class="fl">5</span>,
         <span class="va">Afrotropic</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">slice_sample</span><span class="op">(</span>n <span class="op">=</span> <span class="va">nrow_subsample</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">data_subset</span>

<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">data_subset</span>, file <span class="op">=</span> <span class="st">"data/processed/data_subset.RDS"</span><span class="op">)</span>

<span class="va">model_formula</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">predictors</span>, <span class="va">response</span>, <span class="va">interactions</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">formula</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">response</span>, <span class="st">" ~ "</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"bbs("</span>, <span class="va">predictors</span>, <span class="st">")"</span>, collapse <span class="op">=</span> <span class="st">" + "</span><span class="op">)</span><span class="op">)</span>
  
  <span class="kw">if</span> <span class="op">(</span><span class="va">interactions</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">envir_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu">str_split</span><span class="op">(</span><span class="va">predictors</span>, <span class="st">"_"</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    <span class="va">interactions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">envir_vars</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
      <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"bspatial("</span>, <span class="va">predictors</span><span class="op">[</span><span class="fu">str_starts</span><span class="op">(</span><span class="va">predictors</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"_"</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">", "</span>, 
             <span class="va">predictors</span><span class="op">[</span><span class="fu">str_starts</span><span class="op">(</span><span class="va">predictors</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"_"</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="st">")"</span><span class="op">)</span>
    <span class="op">}</span><span class="op">)</span>
    <span class="va">formula</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">formula</span>, <span class="st">" + "</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">interactions</span>, collapse <span class="op">=</span> <span class="st">" + "</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span>
  
  <span class="va">formula</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="va">formula</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">formula</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">formula_trends</span> <span class="op">&lt;-</span> <span class="fu">model_formula</span><span class="op">(</span><span class="va">predictors_trends</span><span class="op">[</span><span class="op">!</span><span class="va">predictors_trends</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"trend_long"</span>, <span class="st">"trend_short"</span><span class="op">)</span><span class="op">]</span>, <span class="st">"trend_long"</span><span class="op">)</span>
<span class="va">formula_resids</span> <span class="op">&lt;-</span> <span class="fu">model_formula</span><span class="op">(</span><span class="va">predictors_resids</span><span class="op">[</span><span class="op">!</span><span class="va">predictors_resids</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"trend_long"</span>, <span class="st">"trend_short"</span><span class="op">)</span><span class="op">]</span>, <span class="st">"trend_long"</span><span class="op">)</span>
<span class="va">formula_all</span> <span class="op">&lt;-</span> <span class="fu">model_formula</span><span class="op">(</span><span class="va">predictors_all</span><span class="op">[</span><span class="op">!</span><span class="va">predictors_all</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"trend_long"</span>, <span class="st">"trend_short"</span><span class="op">)</span><span class="op">]</span>, <span class="st">"trend_long"</span>, 
                             interactions <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">ctrl</span> <span class="op">&lt;-</span> <span class="fu">boost_control</span><span class="op">(</span>trace <span class="op">=</span> <span class="cn">FALSE</span>, mstop <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span>
<span class="va">mod_trends</span> <span class="op">&lt;-</span> <span class="fu">gamboost</span><span class="op">(</span><span class="va">formula_trends</span>, data <span class="op">=</span> <span class="va">data_subset</span>, family <span class="op">=</span> <span class="fu">Gaussian</span><span class="op">(</span><span class="op">)</span>, control <span class="op">=</span> <span class="va">ctrl</span><span class="op">)</span>
<span class="va">mod_resids</span> <span class="op">&lt;-</span> <span class="fu">gamboost</span><span class="op">(</span><span class="va">formula_resids</span>, data <span class="op">=</span> <span class="va">data_subset</span>, family <span class="op">=</span> <span class="fu">Gaussian</span><span class="op">(</span><span class="op">)</span>, control <span class="op">=</span> <span class="va">ctrl</span><span class="op">)</span>
<span class="va">mod_all</span> <span class="op">&lt;-</span> <span class="fu">gamboost</span><span class="op">(</span><span class="va">formula_all</span>, data <span class="op">=</span> <span class="va">data_subset</span>, family <span class="op">=</span> <span class="fu">Gaussian</span><span class="op">(</span><span class="op">)</span>, control <span class="op">=</span> <span class="va">ctrl</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">mod_trends</span>, file <span class="op">=</span> <span class="st">"data/processed/models/mod_trends.RDS"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">mod_resids</span>, file <span class="op">=</span> <span class="st">"data/processed/models/mod_resids.RDS"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">mod_all</span>, file <span class="op">=</span> <span class="st">"data/processed/models/mod_all.RDS"</span><span class="op">)</span></code></pre></div>
<div id="determine-the-optimal-number-of-boosting-iterations" class="section level4">
<h4>
<span class="header-section-number">6.4.2.1</span> Determine the optimal number of boosting iterations<a class="anchor" aria-label="anchor" href="#determine-the-optimal-number-of-boosting-iterations"><i class="fas fa-link"></i></a>
</h4>
<p>Having trained the models, we can now determine the optimal number of boosting iterations. As this is a time-consuming process, the chunk below does not run by default and it’s probably best to run this cross-validation procedure separately through the dedicated <code>R/hyperparm_mboost_mstop.R</code> script.</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">250</span>, to <span class="op">=</span> <span class="fl">30000</span>, by <span class="op">=</span> <span class="fl">250</span><span class="op">)</span>
<span class="va">cv10f_trends</span> <span class="op">&lt;-</span> <span class="fu">cv</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/model.extract.html">model.weights</a></span><span class="op">(</span><span class="va">mod_trends</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"kfold"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">cv10f_trends</span>, file <span class="op">=</span> <span class="st">"data/processed/models/cv10f_trends.RDS"</span><span class="op">)</span>
<span class="va">cvm_trends</span> <span class="op">&lt;-</span> <span class="fu">cvrisk</span><span class="op">(</span><span class="va">mod_trends</span>, folds <span class="op">=</span> <span class="va">cv10f_trends</span>, grid <span class="op">=</span> <span class="va">grid</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">cvm_trends</span>, file <span class="op">=</span> <span class="st">"data/processed/models/cvm_trends.RDS"</span><span class="op">)</span>

<span class="va">cv10f_resids</span> <span class="op">&lt;-</span> <span class="fu">cv</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/model.extract.html">model.weights</a></span><span class="op">(</span><span class="va">mod_resids</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"kfold"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">cv10f_resids</span>, file <span class="op">=</span> <span class="st">"data/processed/models/cv10f_resids.RDS"</span><span class="op">)</span>
<span class="va">cvm_resids</span> <span class="op">&lt;-</span> <span class="fu">cvrisk</span><span class="op">(</span><span class="va">mod_resids</span>, folds <span class="op">=</span> <span class="va">cv10f_resids</span>, grid <span class="op">=</span> <span class="va">grid</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">cvm_resids</span>, file <span class="op">=</span> <span class="st">"data/processed/models/cvm_resids.RDS"</span><span class="op">)</span>

<span class="va">cv10f_all</span> <span class="op">&lt;-</span> <span class="fu">cv</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/model.extract.html">model.weights</a></span><span class="op">(</span><span class="va">mod_all</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"kfold"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">cv10f_all</span>, file <span class="op">=</span> <span class="st">"data/processed/models/cv10f_all.RDS"</span><span class="op">)</span>
<span class="va">cvm_all</span> <span class="op">&lt;-</span> <span class="fu">cvrisk</span><span class="op">(</span><span class="va">mod_all</span>, folds <span class="op">=</span> <span class="va">cv10f_all</span>, grid <span class="op">=</span> <span class="va">grid</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">cvm_all</span>, file <span class="op">=</span> <span class="st">"data/processed/models/cvm_all.RDS"</span><span class="op">)</span></code></pre></div>
<p>We can load the results and plot the outputs.</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cvm_trends</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/processed/models/cvm_trends.RDS"</span><span class="op">)</span>
<span class="va">cvm_resids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/processed/models/cvm_resids.RDS"</span><span class="op">)</span>
<span class="va">cvm_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/processed/models/cvm_all.RDS"</span><span class="op">)</span>

<span class="va">plot_cvm</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">cvm</span>, <span class="va">plot_id</span> <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">m</span> <span class="op">&lt;-</span> <span class="va">cvm</span>
  <span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">rownames_to_column</span><span class="op">(</span>var <span class="op">=</span> <span class="st">"fold"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">pivot_longer</span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">fold</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"boosts"</span>, values_to <span class="op">=</span> <span class="st">"risk"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">mutate</span><span class="op">(</span>boosts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">boosts</span><span class="op">)</span>,
           fold <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">fold</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/base/identity.html">identity</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">boosts</span>, y <span class="op">=</span> <span class="va">risk</span>, group <span class="op">=</span> <span class="va">fold</span>, color <span class="op">=</span> <span class="va">fold</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
      <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
      <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">cvm</span>, <span class="st">"type"</span><span class="op">)</span>, <span class="st">": "</span>, <span class="va">plot_id</span><span class="op">)</span>, x <span class="op">=</span> <span class="st">"boosts (mstop)"</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">cvm</span>, <span class="st">"risk"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">plot_cvm_trends</span> <span class="op">&lt;-</span> <span class="fu">plot_cvm</span><span class="op">(</span><span class="va">cvm_trends</span>, <span class="st">"trends"</span><span class="op">)</span>
<span class="va">plot_cvm_resids</span> <span class="op">&lt;-</span> <span class="fu">plot_cvm</span><span class="op">(</span><span class="va">cvm_resids</span>, <span class="st">"resids"</span><span class="op">)</span>
<span class="va">plot_cvm_all</span> <span class="op">&lt;-</span> <span class="fu">plot_cvm</span><span class="op">(</span><span class="va">cvm_all</span>, <span class="st">"all"</span><span class="op">)</span>

<span class="va">plot_cvm_trends</span> <span class="op">+</span> <span class="va">plot_cvm_resids</span> <span class="op">+</span> <span class="va">plot_cvm_all</span> <span class="op">+</span> <span class="fu">plot_layout</span><span class="op">(</span>guides <span class="op">=</span> <span class="st">"collect"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="06.Model-assemblage-trends_files/figure-html/plot_cvm_results-1.png" width="100%"></div>
<p>We can see that most cross-validated models seem to show stagnating model improvement beyond 10000 boosts, while an optimum is mostly not reached before 30000 boosts. Given the stagnating improvement, limited compute time and no need to optimize predictive performance ad infinitum, we limit the number of boosts to 10000.</p>
</div>
<div id="correct-for-spatial-autocorrelation" class="section level4">
<h4>
<span class="header-section-number">6.4.2.2</span> Correct for spatial autocorrelation<a class="anchor" aria-label="anchor" href="#correct-for-spatial-autocorrelation"><i class="fas fa-link"></i></a>
</h4>
<p>A quick plot of model residuals will show there is strong spatial autocorrelation in the residuals, violating the independence assumption of regression modelling.</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html">exists</a></span><span class="op">(</span><span class="st">"mod_trends"</span><span class="op">)</span><span class="op">)</span> <span class="va">mod_trends</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/processed/models/mod_trends.RDS"</span><span class="op">)</span>
<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html">exists</a></span><span class="op">(</span><span class="st">"mod_resids"</span><span class="op">)</span><span class="op">)</span> <span class="va">mod_resids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/processed/models/mod_resids.RDS"</span><span class="op">)</span>
<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html">exists</a></span><span class="op">(</span><span class="st">"mod_all"</span><span class="op">)</span><span class="op">)</span> <span class="va">mod_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/processed/models/mod_all.RDS"</span><span class="op">)</span>
<span class="va">data_subset</span><span class="op">$</span><span class="va">norac_trends</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">resid</a></span><span class="op">(</span><span class="va">mod_trends</span><span class="op">)</span>
<span class="va">data_subset</span><span class="op">$</span><span class="va">norac_resids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">resid</a></span><span class="op">(</span><span class="va">mod_resids</span><span class="op">)</span>
<span class="va">data_subset</span><span class="op">$</span><span class="va">norac_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">resid</a></span><span class="op">(</span><span class="va">mod_all</span><span class="op">)</span>

<span class="va">data_subset</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">norac_trends</span>, <span class="va">norac_resids</span>, <span class="va">norac_all</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">rename</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>Predictability <span class="op">=</span> <span class="va">norac_resids</span>, Trends <span class="op">=</span> <span class="va">norac_trends</span>, `All predictors` <span class="op">=</span> <span class="va">norac_all</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">pivot_longer</span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"model"</span>, values_to <span class="op">=</span> <span class="st">"residuals"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, color <span class="op">=</span> <span class="va">residuals</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_color_gradient2</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">coord_fixed</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Spatial pattern of model residuals"</span>, x <span class="op">=</span> <span class="st">"Longitude"</span>, y <span class="op">=</span> <span class="st">"Latitude"</span>, color <span class="op">=</span> <span class="st">"Residual"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="06.Model-assemblage-trends_files/figure-html/plot_residual_spatial_autocorrelation-1.png" width="100%"></div>
<p>There’s no need to even quantify spatial autocorrelation (SAC) in residuals here, as it’s so obvious. We will correct for it using the residual autocovariate method introduced by Crase et al. <span class="citation"><sup><a href="references.html#ref-crase2012" role="doc-biblioref">4</a></sup></span>. We calculate the autocovariate of the residuals using a neighborhood radius of 100 kilometers. <strong>This radius could be optimized to reflect actual SAC distances in our dataset, but for now it seems sufficient to dramatically reduce residual SAC.</strong></p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">neighborhood_dist</span> <span class="op">&lt;-</span> <span class="fl">100</span>  <span class="co"># Kilometers if longlat = TRUE</span>
<span class="va">acov_trends</span> <span class="op">&lt;-</span> <span class="fu">autocov_dist</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">resid</a></span><span class="op">(</span><span class="va">mod_trends</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">data_subset</span><span class="op">$</span><span class="va">x</span>, <span class="va">data_subset</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>, longlat <span class="op">=</span> <span class="cn">TRUE</span>, 
                            nbs <span class="op">=</span> <span class="va">neighborhood_dist</span>, zero.policy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<pre><code>## Warning in autocov_dist(resid(mod_trends), as.matrix(cbind(data_subset$x, : With
## value 100 some points have no neighbours</code></pre>
<pre><code>## Warning in nb2listw(nb, glist = gl, style = style, zero.policy = zero.policy):
## zero sum general weights</code></pre>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">acov_resids</span> <span class="op">&lt;-</span> <span class="fu">autocov_dist</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">resid</a></span><span class="op">(</span><span class="va">mod_resids</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">data_subset</span><span class="op">$</span><span class="va">x</span>, <span class="va">data_subset</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>, longlat <span class="op">=</span> <span class="cn">TRUE</span>,
                            nbs <span class="op">=</span> <span class="va">neighborhood_dist</span>, zero.policy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<pre><code>## Warning in autocov_dist(resid(mod_resids), as.matrix(cbind(data_subset$x, : With
## value 100 some points have no neighbours

## Warning in autocov_dist(resid(mod_resids), as.matrix(cbind(data_subset$x, : zero
## sum general weights</code></pre>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">acov_all</span> <span class="op">&lt;-</span> <span class="fu">autocov_dist</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">resid</a></span><span class="op">(</span><span class="va">mod_all</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">data_subset</span><span class="op">$</span><span class="va">x</span>, <span class="va">data_subset</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>, longlat <span class="op">=</span> <span class="cn">TRUE</span>,
                         nbs <span class="op">=</span> <span class="va">neighborhood_dist</span>, zero.policy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<pre><code>## Warning in autocov_dist(resid(mod_all), as.matrix(cbind(data_subset$x,
## data_subset$y)), : With value 100 some points have no neighbours

## Warning in autocov_dist(resid(mod_all), as.matrix(cbind(data_subset$x,
## data_subset$y)), : zero sum general weights</code></pre>
<p>The chunk above may throw some warnings if some points are not within 100 kilometers from other points, but that will most certainly not be many points in our dataset, so we can accept that some of these autocovariates are not as accurate as others.</p>
<p>Now we will add the calculated autocovariates of residuals to our earlier dataset and retrain the models.</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data_subset</span><span class="op">$</span><span class="va">autocov_trends</span> <span class="op">&lt;-</span> <span class="va">acov_trends</span>
<span class="va">data_subset</span><span class="op">$</span><span class="va">autocov_resids</span> <span class="op">&lt;-</span> <span class="va">acov_resids</span>
<span class="va">data_subset</span><span class="op">$</span><span class="va">autocov_all</span> <span class="op">&lt;-</span> <span class="va">acov_all</span>

<span class="va">formula_rac</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">formula</span>, <span class="va">var</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">formula</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">formula</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, sep <span class="op">=</span> <span class="st">" ~ "</span><span class="op">)</span>, <span class="st">" + bbs("</span>, <span class="va">var</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">formula_trends</span> <span class="op">&lt;-</span> <span class="fu">formula_rac</span><span class="op">(</span><span class="va">formula_trends</span>, <span class="st">"autocov_trends"</span><span class="op">)</span>
<span class="va">formula_resids</span> <span class="op">&lt;-</span> <span class="fu">formula_rac</span><span class="op">(</span><span class="va">formula_resids</span>, <span class="st">"autocov_resids"</span><span class="op">)</span>
<span class="va">formula_all</span> <span class="op">&lt;-</span> <span class="fu">formula_rac</span><span class="op">(</span><span class="va">formula_all</span>, <span class="st">"autocov_all"</span><span class="op">)</span>

<span class="va">ctrl</span> <span class="op">&lt;-</span> <span class="fu">boost_control</span><span class="op">(</span>trace <span class="op">=</span> <span class="cn">FALSE</span>, mstop <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span>
<span class="va">mod_trends_rac</span> <span class="op">&lt;-</span> <span class="fu">gamboost</span><span class="op">(</span><span class="va">formula_trends</span>, data <span class="op">=</span> <span class="va">data_subset</span>, family <span class="op">=</span> <span class="fu">Gaussian</span><span class="op">(</span><span class="op">)</span>, control <span class="op">=</span> <span class="va">ctrl</span><span class="op">)</span>
<span class="va">mod_resids_rac</span> <span class="op">&lt;-</span> <span class="fu">gamboost</span><span class="op">(</span><span class="va">formula_resids</span>, data <span class="op">=</span> <span class="va">data_subset</span>, family <span class="op">=</span> <span class="fu">Gaussian</span><span class="op">(</span><span class="op">)</span>, control <span class="op">=</span> <span class="va">ctrl</span><span class="op">)</span>
<span class="va">mod_all_rac</span> <span class="op">&lt;-</span> <span class="fu">gamboost</span><span class="op">(</span><span class="va">formula_all</span>, data <span class="op">=</span> <span class="va">data_subset</span>, family <span class="op">=</span> <span class="fu">Gaussian</span><span class="op">(</span><span class="op">)</span>, control <span class="op">=</span> <span class="va">ctrl</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">mod_trends_rac</span>, file <span class="op">=</span> <span class="st">"data/processed/models/mod_trends_rac.RDS"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">mod_resids_rac</span>, file <span class="op">=</span> <span class="st">"data/processed/models/mod_resids_rac.RDS"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">mod_all_rac</span>, file <span class="op">=</span> <span class="st">"data/processed/models/mod_all_rac.RDS"</span><span class="op">)</span></code></pre></div>
<p>And now let’s reassess residual autocorrelation from our retrained model. If all went well, that should be visibly and substantially less than before.</p>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html">exists</a></span><span class="op">(</span><span class="st">"mod_trends_rac"</span><span class="op">)</span><span class="op">)</span> <span class="va">mod_trends_rac</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/processed/models/mod_trends_rac.RDS"</span><span class="op">)</span>
<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html">exists</a></span><span class="op">(</span><span class="st">"mod_resids_rac"</span><span class="op">)</span><span class="op">)</span> <span class="va">mod_resids_rac</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/processed/models/mod_resids_rac.RDS"</span><span class="op">)</span>
<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html">exists</a></span><span class="op">(</span><span class="st">"mod_all_rac"</span><span class="op">)</span><span class="op">)</span> <span class="va">mod_all_rac</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/processed/models/mod_all_rac.RDS"</span><span class="op">)</span>
<span class="va">data_subset</span><span class="op">$</span><span class="va">rac_trends</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">resid</a></span><span class="op">(</span><span class="va">mod_trends_rac</span><span class="op">)</span>
<span class="va">data_subset</span><span class="op">$</span><span class="va">rac_resids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">resid</a></span><span class="op">(</span><span class="va">mod_resids_rac</span><span class="op">)</span>
<span class="va">data_subset</span><span class="op">$</span><span class="va">rac_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">resid</a></span><span class="op">(</span><span class="va">mod_all_rac</span><span class="op">)</span>

<span class="va">data_subset</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">rac_trends</span>, <span class="va">rac_resids</span>, <span class="va">rac_all</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">rename</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>Predictability <span class="op">=</span> <span class="va">rac_resids</span>, Trends <span class="op">=</span> <span class="va">rac_trends</span>, `All predictors` <span class="op">=</span> <span class="va">rac_all</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">pivot_longer</span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"model"</span>, values_to <span class="op">=</span> <span class="st">"residuals"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, color <span class="op">=</span> <span class="va">residuals</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_color_gradient2</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">coord_fixed</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Spatial pattern of model residuals"</span>, subtitle <span class="op">=</span> <span class="st">"after including residual autocovariates"</span>,
       x <span class="op">=</span> <span class="st">"Longitude"</span>, y <span class="op">=</span> <span class="st">"Latitude"</span>, color <span class="op">=</span> <span class="st">"Residual"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="06.Model-assemblage-trends_files/figure-html/plot_residual_spatial_autocorrelation_after_rac-1.png" width="100%"></div>
<p>That is <em>much</em> better!</p>
</div>
<div id="determine-the-optimal-number-of-boosting-iterations-of-rac-model" class="section level4">
<h4>
<span class="header-section-number">6.4.2.3</span> Determine the optimal number of boosting iterations of RAC model<a class="anchor" aria-label="anchor" href="#determine-the-optimal-number-of-boosting-iterations-of-rac-model"><i class="fas fa-link"></i></a>
</h4>
<p>Once again, we should make sure the number of boosts used (10000) is ‘optimal’ in our newly trained model. As before, it’s probably best to run this using the dedicated file in <code>R/hyperparm_mboost_mstop.R</code>, but the chunk below can do it as well.</p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">250</span>, to <span class="op">=</span> <span class="fl">30000</span>, by <span class="op">=</span> <span class="fl">250</span><span class="op">)</span>
<span class="va">cv10f_trends_rac</span> <span class="op">&lt;-</span> <span class="fu">cv</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/model.extract.html">model.weights</a></span><span class="op">(</span><span class="va">mod_trends_rac</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"kfold"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">cv10f_trends_rac</span>, file <span class="op">=</span> <span class="st">"data/processed/models/cv10f_trends_rac.RDS"</span><span class="op">)</span>
<span class="va">cvm_trends_rac</span> <span class="op">&lt;-</span> <span class="fu">cvrisk</span><span class="op">(</span><span class="va">mod_trends_rac</span>, folds <span class="op">=</span> <span class="va">cv10f_trends_rac</span>, grid <span class="op">=</span> <span class="va">grid</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">cvm_trends_rac</span>, file <span class="op">=</span> <span class="st">"data/processed/models/cvm_trends_rac.RDS"</span><span class="op">)</span>

<span class="va">cv10f_resids_rac</span> <span class="op">&lt;-</span> <span class="fu">cv</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/model.extract.html">model.weights</a></span><span class="op">(</span><span class="va">mod_resids_rac</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"kfold"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">cv10f_resids_rac</span>, file <span class="op">=</span> <span class="st">"data/processed/models/cv10f_resids_rac.RDS"</span><span class="op">)</span>
<span class="va">cvm_resids_rac</span> <span class="op">&lt;-</span> <span class="fu">cvrisk</span><span class="op">(</span><span class="va">mod_resids_rac</span>, folds <span class="op">=</span> <span class="va">cv10f_resids_rac</span>, grid <span class="op">=</span> <span class="va">grid</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">cvm_resids_rac</span>, file <span class="op">=</span> <span class="st">"data/processed/models/cvm_resids_rac.RDS"</span><span class="op">)</span>

<span class="va">cv10f_all_rac</span> <span class="op">&lt;-</span> <span class="fu">cv</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/model.extract.html">model.weights</a></span><span class="op">(</span><span class="va">mod_all_rac</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"kfold"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">cv10f_all_rac</span>, file <span class="op">=</span> <span class="st">"data/processed/models/cv10f_all_rac.RDS"</span><span class="op">)</span>
<span class="va">cvm_all_rac</span> <span class="op">&lt;-</span> <span class="fu">cvrisk</span><span class="op">(</span><span class="va">mod_all_rac</span>, folds <span class="op">=</span> <span class="va">cv10f_all_rac</span>, grid <span class="op">=</span> <span class="va">grid</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">cvm_all_rac</span>, file <span class="op">=</span> <span class="st">"data/processed/models/cvm_all_rac.RDS"</span><span class="op">)</span></code></pre></div>
<p>We can load these results as well and plot the outputs.</p>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cvm_trends_rac</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/processed/models/cvm_trends_rac.RDS"</span><span class="op">)</span>
<span class="va">cvm_resids_rac</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/processed/models/cvm_resids_rac.RDS"</span><span class="op">)</span>
<span class="va">cvm_all_rac</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/processed/models/cvm_all_rac.RDS"</span><span class="op">)</span>

<span class="va">plot_cvm</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">cvm</span>, <span class="va">plot_id</span> <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">m</span> <span class="op">&lt;-</span> <span class="va">cvm</span>
  <span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">rownames_to_column</span><span class="op">(</span>var <span class="op">=</span> <span class="st">"fold"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">pivot_longer</span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">fold</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"boosts"</span>, values_to <span class="op">=</span> <span class="st">"risk"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">mutate</span><span class="op">(</span>boosts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">boosts</span><span class="op">)</span>,
           fold <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">fold</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/base/identity.html">identity</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">boosts</span>, y <span class="op">=</span> <span class="va">risk</span>, group <span class="op">=</span> <span class="va">fold</span>, color <span class="op">=</span> <span class="va">fold</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
      <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
      <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">cvm</span>, <span class="st">"type"</span><span class="op">)</span>, <span class="st">": "</span>, <span class="va">plot_id</span><span class="op">)</span>, x <span class="op">=</span> <span class="st">"boosts (mstop)"</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">cvm</span>, <span class="st">"risk"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">plot_cvm_trends_rac</span> <span class="op">&lt;-</span> <span class="fu">plot_cvm</span><span class="op">(</span><span class="va">cvm_trends_rac</span>, <span class="st">"trends"</span><span class="op">)</span>
<span class="va">plot_cvm_resids_rac</span> <span class="op">&lt;-</span> <span class="fu">plot_cvm</span><span class="op">(</span><span class="va">cvm_resids_rac</span>, <span class="st">"resids"</span><span class="op">)</span>
<span class="va">plot_cvm_all_rac</span> <span class="op">&lt;-</span> <span class="fu">plot_cvm</span><span class="op">(</span><span class="va">cvm_all_rac</span>, <span class="st">"all"</span><span class="op">)</span>

<span class="va">plot_cvm_trends_rac</span> <span class="op">+</span> <span class="va">plot_cvm_resids_rac</span> <span class="op">+</span> <span class="va">plot_cvm_all_rac</span> <span class="op">+</span> 
  <span class="fu">plot_layout</span><span class="op">(</span>guides <span class="op">=</span> <span class="st">"collect"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="06.Model-assemblage-trends_files/figure-html/plot_cvm_results_rac_models-1.png" width="100%"></div>
<p>Although model improvement did not stagnate as fast in this model, stopping boosting iterations at 10000 boosts again continues to remain reasonable. We could increase it to 20000, but that would (probably) at least double the time required for bootstrapping to quantify model uncertainty in further steps. As predictive performance is not the ultimate goal of this analysis, that trade-off is fine.</p>
</div>
<div id="quantifying-residual-autocorrelation" class="section level4">
<h4>
<span class="header-section-number">6.4.2.4</span> Quantifying residual autocorrelation<a class="anchor" aria-label="anchor" href="#quantifying-residual-autocorrelation"><i class="fas fa-link"></i></a>
</h4>
<p>Now is a good moment to quantify residual autocorrelation (RSAC) in our model. We do so by calculating Moran’s I across a number of distance classes (8) using the <code>sp.correlogram</code> function from the <code>spdep</code> package. As this is computationally very intensive, we run this calculation once in the chunk below and save the results for fast plotting during knitting of this document.</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nclass</span> <span class="op">&lt;-</span> <span class="fl">8</span>  <span class="co"># Number of distance classes</span>
<span class="va">neighbors</span> <span class="op">&lt;-</span> <span class="fu">dnearneigh</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">data_subset</span><span class="op">$</span><span class="va">x</span>, <span class="va">data_subset</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>, d1 <span class="op">=</span> <span class="fl">0</span>, d2 <span class="op">=</span> <span class="va">neighborhood_dist</span>, longlat <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">spc_norac_trends</span> <span class="op">&lt;-</span> <span class="fu">sp.correlogram</span><span class="op">(</span><span class="va">neighbors</span>, <span class="va">data_subset</span><span class="op">$</span><span class="va">norac_trends</span>, order <span class="op">=</span> <span class="va">nclass</span>, method <span class="op">=</span> <span class="st">"I"</span>, zero.policy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">spc_norac_resids</span> <span class="op">&lt;-</span> <span class="fu">sp.correlogram</span><span class="op">(</span><span class="va">neighbors</span>, <span class="va">data_subset</span><span class="op">$</span><span class="va">norac_resids</span>, order <span class="op">=</span> <span class="va">nclass</span>, method <span class="op">=</span> <span class="st">"I"</span>, zero.policy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">spc_norac_all</span> <span class="op">&lt;-</span> <span class="fu">sp.correlogram</span><span class="op">(</span><span class="va">neighbors</span>, <span class="va">data_subset</span><span class="op">$</span><span class="va">norac_all</span>, order <span class="op">=</span> <span class="va">nclass</span>, method <span class="op">=</span> <span class="st">"I"</span>, zero.policy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">spc_rac_trends</span> <span class="op">&lt;-</span> <span class="fu">sp.correlogram</span><span class="op">(</span><span class="va">neighbors</span>, <span class="va">data_subset</span><span class="op">$</span><span class="va">rac_trends</span>, order <span class="op">=</span> <span class="va">nclass</span>, method <span class="op">=</span> <span class="st">"I"</span>, zero.policy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">spc_rac_resids</span> <span class="op">&lt;-</span> <span class="fu">sp.correlogram</span><span class="op">(</span><span class="va">neighbors</span>, <span class="va">data_subset</span><span class="op">$</span><span class="va">rac_resids</span>, order <span class="op">=</span> <span class="va">nclass</span>, method <span class="op">=</span> <span class="st">"I"</span>, zero.policy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">spc_rac_all</span> <span class="op">&lt;-</span> <span class="fu">sp.correlogram</span><span class="op">(</span><span class="va">neighbors</span>, <span class="va">data_subset</span><span class="op">$</span><span class="va">rac_all</span>, order <span class="op">=</span> <span class="va">nclass</span>, method <span class="op">=</span> <span class="st">"I"</span>, zero.policy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">spc_norac_trends</span>, file <span class="op">=</span> <span class="st">"data/processed/models/spc_norac_trends.RDS"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">spc_norac_resids</span>, file <span class="op">=</span> <span class="st">"data/processed/models/spc_norac_resids.RDS"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">spc_norac_all</span>, file <span class="op">=</span> <span class="st">"data/processed/models/spc_norac_all.RDS"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">spc_rac_trends</span>, file <span class="op">=</span> <span class="st">"data/processed/models/spc_rac_trends.RDS"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">spc_rac_resids</span>, file <span class="op">=</span> <span class="st">"data/processed/models/spc_rac_resids.RDS"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">spc_rac_all</span>, file <span class="op">=</span> <span class="st">"data/processed/models/spc_rac_all.RDS"</span><span class="op">)</span></code></pre></div>
<p>And we can now plot the RSAC correlograms.</p>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html">exists</a></span><span class="op">(</span><span class="st">"spc_norac_trends"</span><span class="op">)</span><span class="op">)</span> <span class="va">spc_norac_trends</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/processed/models/spc_norac_trends.RDS"</span><span class="op">)</span>
<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html">exists</a></span><span class="op">(</span><span class="st">"spc_norac_resids"</span><span class="op">)</span><span class="op">)</span> <span class="va">spc_norac_resids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/processed/models/spc_norac_resids.RDS"</span><span class="op">)</span>
<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html">exists</a></span><span class="op">(</span><span class="st">"spc_norac_all"</span><span class="op">)</span><span class="op">)</span> <span class="va">spc_norac_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/processed/models/spc_norac_all.RDS"</span><span class="op">)</span>
<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html">exists</a></span><span class="op">(</span><span class="st">"spc_rac_trends"</span><span class="op">)</span><span class="op">)</span> <span class="va">spc_rac_trends</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/processed/models/spc_rac_trends.RDS"</span><span class="op">)</span>
<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html">exists</a></span><span class="op">(</span><span class="st">"spc_rac_resids"</span><span class="op">)</span><span class="op">)</span> <span class="va">spc_rac_resids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/processed/models/spc_rac_resids.RDS"</span><span class="op">)</span>
<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html">exists</a></span><span class="op">(</span><span class="st">"spc_rac_all"</span><span class="op">)</span><span class="op">)</span> <span class="va">spc_rac_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/processed/models/spc_rac_all.RDS"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">spc_norac_trends</span>, main <span class="op">=</span> <span class="st">"RSAC Trends mdl"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">spc_norac_resids</span>, main <span class="op">=</span> <span class="st">"RSAC Predictability mdl"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">spc_norac_all</span>, main <span class="op">=</span> <span class="st">"RSAC All preds mdl"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">spc_rac_trends</span>, main <span class="op">=</span> <span class="st">"RSAC Trends RAC mdl"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">spc_rac_resids</span>, main <span class="op">=</span> <span class="st">"RSAC Predictability RAC mdl"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">spc_rac_all</span>, main <span class="op">=</span> <span class="st">"RSAC All preds RAC mdl"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="06.Model-assemblage-trends_files/figure-html/plot_rsac-1.png" width="100%"></div>
<p>Adding the autocovariate of residuals seems to have helped a lot to counter residual spatial autocorrelation. <strong>It’s possible this can be improved further by tweaking the radius of the neighborhood over which the autocovariate is calculated, but that’s some tweaking we can do later.</strong></p>
</div>
</div>
<div id="model-outputs" class="section level3">
<h3>
<span class="header-section-number">6.4.3</span> Model outputs<a class="anchor" aria-label="anchor" href="#model-outputs"><i class="fas fa-link"></i></a>
</h3>
<div id="model-performance" class="section level4">
<h4>
<span class="header-section-number">6.4.3.1</span> Model performance<a class="anchor" aria-label="anchor" href="#model-performance"><i class="fas fa-link"></i></a>
</h4>
<p>We use good ol’ RMSE, % of deviance explained and Moran’s I to compare the performance of all these models.</p>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">perf_metrics</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">actual</span>, <span class="va">models</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">rmse</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">models</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">rmse</span><span class="op">(</span><span class="va">actual</span>, <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="va">deviance_explained</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">models</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="fu">risk</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu">risk</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span>
  <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">rmse</span>, <span class="va">deviance_explained</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/mode.html">mode</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"numeric"</span>
  <span class="va">m</span>
<span class="op">}</span>

<span class="va">residual_columns</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"norac_trends"</span>, <span class="st">"norac_resids"</span>, <span class="st">"norac_all"</span>, <span class="st">"rac_trends"</span>, <span class="st">"rac_resids"</span>, <span class="st">"rac_all"</span><span class="op">)</span>
<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html">exists</a></span><span class="op">(</span><span class="st">"neighbors"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">neighbors</span> <span class="op">&lt;-</span> <span class="fu">dnearneigh</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">data_subset</span><span class="op">$</span><span class="va">x</span>, <span class="va">data_subset</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>, d1 <span class="op">=</span> <span class="fl">0</span>, d2 <span class="op">=</span> <span class="va">neighborhood_dist</span>, longlat <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">sar_metrics</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">residual_columns</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">mi</span> <span class="op">&lt;-</span> <span class="fu">moran.test</span><span class="op">(</span><span class="va">data_subset</span><span class="op">[</span>, <span class="va">x</span><span class="op">]</span>, <span class="fu">nb2listw</span><span class="op">(</span><span class="va">neighbors</span>, zero.policy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, zero.policy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">mi</span><span class="op">$</span><span class="va">estimate</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fl">2</span><span class="op">)</span>, <span class="va">mi</span><span class="op">$</span><span class="va">p.value</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="va">sar_metrics</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="va">sar_metrics</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">sar_metrics</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">pm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu">perf_metrics</span><span class="op">(</span><span class="va">data_subset</span><span class="op">$</span><span class="va">trend_long</span>, 
                                 <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">mod_trends</span>, <span class="va">mod_resids</span>, <span class="va">mod_all</span>, <span class="va">mod_trends_rac</span>, <span class="va">mod_resids_rac</span>, <span class="va">mod_all_rac</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">sar_metrics</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">pm</span><span class="op">)</span>
<span class="va">pm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">pm</span>, <span class="va">sar_metrics</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">pm</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"mod_trends"</span>, <span class="st">"mod_resids"</span>, <span class="st">"mod_all"</span>, <span class="st">"mod_trends_rac"</span>, <span class="st">"mod_resids_rac"</span>, <span class="st">"mod_all_rac"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">pm</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"RMSE"</span>, <span class="st">"% Deviance explained"</span>, <span class="st">"Moran's I"</span>, <span class="st">"Moran's I test p-val"</span><span class="op">)</span>
<span class="va">pm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">pm</span><span class="op">)</span><span class="op">)</span>
<span class="va">pm</span></code></pre></div>
<div class="kable-table">
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th align="left"></th>
<th align="right">RMSE</th>
<th align="right">% Deviance explained</th>
<th align="right">Moran’s I</th>
<th align="right">Moran’s I test p-val</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">mod_trends</td>
<td align="right">16.820661</td>
<td align="right">28.84072</td>
<td align="right">0.83</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">mod_resids</td>
<td align="right">13.346926</td>
<td align="right">55.19692</td>
<td align="right">0.73</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">mod_all</td>
<td align="right">11.230939</td>
<td align="right">68.27676</td>
<td align="right">0.64</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">mod_trends_rac</td>
<td align="right">6.834131</td>
<td align="right">88.25341</td>
<td align="right">0.24</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">mod_resids_rac</td>
<td align="right">6.227944</td>
<td align="right">90.24483</td>
<td align="right">0.18</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">mod_all_rac</td>
<td align="right">5.869456</td>
<td align="right">91.33555</td>
<td align="right">0.13</td>
<td align="right">0</td>
</tr>
</tbody>
</table></div>
</div>
</div>
<div id="variable-importance" class="section level4">
<h4>
<span class="header-section-number">6.4.3.2</span> Variable importance<a class="anchor" aria-label="anchor" href="#variable-importance"><i class="fas fa-link"></i></a>
</h4>
<p>We can quantify the importance of variables within our model using the <code>varimp</code> function of the <code>mboost</code> package. This returns variable importance, a measure of the total improvement to model deviance a variable is responsible for. This is weighted by the number of times a predictor is selected in the boosted models.</p>
<div id="trends-model" class="section level5">
<h5>
<span class="header-section-number">6.4.3.2.1</span> Trends model<a class="anchor" aria-label="anchor" href="#trends-model"><i class="fas fa-link"></i></a>
</h5>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="fu">varimp</span><span class="op">(</span><span class="va">mod_trends_rac</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">"Varimp Trends RAC mdl"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="06.Model-assemblage-trends_files/figure-html/varimp_trends-1.png" width="100%"></div>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu">varimp</span><span class="op">(</span><span class="va">mod_trends_rac</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">reduction</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>imp <span class="op">=</span> <span class="va">reduction</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">reduction</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>,
         imp_biol <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">blearner</span>, <span class="st">"autocov"</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">imp</span><span class="op">)</span>,
         imp_biol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="op">(</span><span class="va">imp_biol</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">imp_biol</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,
         imp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">imp</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="kable-table">
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th align="right">reduction</th>
<th align="left">blearner</th>
<th align="left">variable</th>
<th align="right">selfreq</th>
<th align="right">imp</th>
<th align="right">imp_biol</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">269.422461</td>
<td align="left">bbs(autocov_trends)</td>
<td align="left">autocov_trends</td>
<td align="right">0.2410</td>
<td align="right">76.78</td>
<td align="right">0.00</td>
</tr>
<tr class="even">
<td align="right">46.902638</td>
<td align="left">bbs(tm_trend)</td>
<td align="left">tm_trend</td>
<td align="right">0.2565</td>
<td align="right">13.37</td>
<td align="right">57.56</td>
</tr>
<tr class="odd">
<td align="right">21.384352</td>
<td align="left">bbs(pr_trend)</td>
<td align="left">pr_trend</td>
<td align="right">0.1996</td>
<td align="right">6.09</td>
<td align="right">26.24</td>
</tr>
<tr class="even">
<td align="right">4.796977</td>
<td align="left">bbs(aet_trend)</td>
<td align="left">aet_trend</td>
<td align="right">0.1274</td>
<td align="right">1.37</td>
<td align="right">5.89</td>
</tr>
<tr class="odd">
<td align="right">4.594185</td>
<td align="left">bbs(pet_trend)</td>
<td align="left">pet_trend</td>
<td align="right">0.1399</td>
<td align="right">1.31</td>
<td align="right">5.64</td>
</tr>
<tr class="even">
<td align="right">3.801587</td>
<td align="left">bbs(ndvi_trend)</td>
<td align="left">ndvi_trend</td>
<td align="right">0.0356</td>
<td align="right">1.08</td>
<td align="right">4.67</td>
</tr>
</tbody>
</table></div>
</div>
</div>
<div id="predictability-model" class="section level5">
<h5>
<span class="header-section-number">6.4.3.2.2</span> Predictability model<a class="anchor" aria-label="anchor" href="#predictability-model"><i class="fas fa-link"></i></a>
</h5>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="fu">varimp</span><span class="op">(</span><span class="va">mod_resids_rac</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">"Varimp Predictability RAC mdl"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="06.Model-assemblage-trends_files/figure-html/varimp_resids-1.png" width="100%"></div>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu">varimp</span><span class="op">(</span><span class="va">mod_resids_rac</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">reduction</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>imp <span class="op">=</span> <span class="va">reduction</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">reduction</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>,
         imp_biol <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">blearner</span>, <span class="st">"autocov"</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">imp</span><span class="op">)</span>,
         imp_biol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="op">(</span><span class="va">imp_biol</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">imp_biol</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,
         imp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">imp</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="kable-table">
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th align="right">reduction</th>
<th align="left">blearner</th>
<th align="left">variable</th>
<th align="right">selfreq</th>
<th align="right">imp</th>
<th align="right">imp_biol</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">177.3754837</td>
<td align="left">bbs(autocov_resids)</td>
<td align="left">autocov_resids</td>
<td align="right">0.1691</td>
<td align="right">49.43</td>
<td align="right">0.00</td>
</tr>
<tr class="even">
<td align="right">94.7949396</td>
<td align="left">bbs(ndvi_resid)</td>
<td align="left">ndvi_resid</td>
<td align="right">0.5856</td>
<td align="right">26.42</td>
<td align="right">52.24</td>
</tr>
<tr class="odd">
<td align="right">57.5502643</td>
<td align="left">bbs(tm_resid)</td>
<td align="left">tm_resid</td>
<td align="right">0.0712</td>
<td align="right">16.04</td>
<td align="right">31.72</td>
</tr>
<tr class="even">
<td align="right">17.5826413</td>
<td align="left">bbs(pet_resid)</td>
<td align="left">pet_resid</td>
<td align="right">0.0631</td>
<td align="right">4.90</td>
<td align="right">9.69</td>
</tr>
<tr class="odd">
<td align="right">10.6466394</td>
<td align="left">bbs(aet_resid)</td>
<td align="left">aet_resid</td>
<td align="right">0.0616</td>
<td align="right">2.97</td>
<td align="right">5.87</td>
</tr>
<tr class="even">
<td align="right">0.8702888</td>
<td align="left">bbs(pr_resid)</td>
<td align="left">pr_resid</td>
<td align="right">0.0494</td>
<td align="right">0.24</td>
<td align="right">0.48</td>
</tr>
</tbody>
</table></div>
</div>
</div>
<div id="all-predictor-models" class="section level5">
<h5>
<span class="header-section-number">6.4.3.2.3</span> All predictor models<a class="anchor" aria-label="anchor" href="#all-predictor-models"><i class="fas fa-link"></i></a>
</h5>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="fu">varimp</span><span class="op">(</span><span class="va">mod_all_rac</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">"Varimp All pred RAC mdl"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="06.Model-assemblage-trends_files/figure-html/varimp_all-1.png" width="100%"></div>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu">varimp</span><span class="op">(</span><span class="va">mod_all_rac</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">reduction</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>imp <span class="op">=</span> <span class="va">reduction</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">reduction</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>,
         imp_biol <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">blearner</span>, <span class="st">"autocov"</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">imp</span><span class="op">)</span>,
         imp_biol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="op">(</span><span class="va">imp_biol</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">imp_biol</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>,
         imp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">imp</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">20</span><span class="op">)</span></code></pre></div>
<div class="kable-table">
<div class="inline-table"><table class="table table-sm">
<colgroup>
<col width="13%">
<col width="36%">
<col width="25%">
<col width="8%">
<col width="6%">
<col width="9%">
</colgroup>
<thead><tr class="header">
<th align="right">reduction</th>
<th align="left">blearner</th>
<th align="left">variable</th>
<th align="right">selfreq</th>
<th align="right">imp</th>
<th align="right">imp_biol</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">139.9040016</td>
<td align="left">bbs(autocov_all)</td>
<td align="left">autocov_all</td>
<td align="right">0.0352</td>
<td align="right">38.52</td>
<td align="right">0.00</td>
</tr>
<tr class="even">
<td align="right">127.0774984</td>
<td align="left">bspatial(tm_trend, tm_resid)</td>
<td align="left">tm_resid, tm_trend</td>
<td align="right">0.2324</td>
<td align="right">34.99</td>
<td align="right">56.92</td>
</tr>
<tr class="odd">
<td align="right">56.2974251</td>
<td align="left">bbs(ndvi_resid)</td>
<td align="left">ndvi_resid</td>
<td align="right">0.1593</td>
<td align="right">15.50</td>
<td align="right">25.22</td>
</tr>
<tr class="even">
<td align="right">18.0412086</td>
<td align="left">bspatial(aet_trend, aet_resid)</td>
<td align="left">aet_resid, aet_trend</td>
<td align="right">0.2036</td>
<td align="right">4.97</td>
<td align="right">8.08</td>
</tr>
<tr class="odd">
<td align="right">12.2534894</td>
<td align="left">bspatial(pet_trend, pet_resid)</td>
<td align="left">pet_resid, pet_trend</td>
<td align="right">0.1641</td>
<td align="right">3.37</td>
<td align="right">5.49</td>
</tr>
<tr class="even">
<td align="right">4.1345608</td>
<td align="left">bspatial(ndvi_trend, ndvi_resid)</td>
<td align="left">ndvi_resid, ndvi_trend</td>
<td align="right">0.0977</td>
<td align="right">1.14</td>
<td align="right">1.85</td>
</tr>
<tr class="odd">
<td align="right">2.6364365</td>
<td align="left">bbs(pr_trend)</td>
<td align="left">pr_trend</td>
<td align="right">0.0058</td>
<td align="right">0.73</td>
<td align="right">1.18</td>
</tr>
<tr class="even">
<td align="right">1.1339132</td>
<td align="left">bbs(pet_resid)</td>
<td align="left">pet_resid</td>
<td align="right">0.0082</td>
<td align="right">0.31</td>
<td align="right">0.51</td>
</tr>
<tr class="odd">
<td align="right">0.8446243</td>
<td align="left">bbs(aet_resid)</td>
<td align="left">aet_resid</td>
<td align="right">0.0073</td>
<td align="right">0.23</td>
<td align="right">0.38</td>
</tr>
<tr class="even">
<td align="right">0.4523058</td>
<td align="left">bspatial(pr_trend, pr_resid)</td>
<td align="left">pr_resid, pr_trend</td>
<td align="right">0.0610</td>
<td align="right">0.12</td>
<td align="right">0.20</td>
</tr>
<tr class="odd">
<td align="right">0.1833741</td>
<td align="left">bbs(pet_trend)</td>
<td align="left">pet_trend</td>
<td align="right">0.0095</td>
<td align="right">0.05</td>
<td align="right">0.08</td>
</tr>
<tr class="even">
<td align="right">0.0976552</td>
<td align="left">bbs(tm_trend)</td>
<td align="left">tm_trend</td>
<td align="right">0.0123</td>
<td align="right">0.03</td>
<td align="right">0.04</td>
</tr>
<tr class="odd">
<td align="right">0.0790772</td>
<td align="left">bbs(aet_trend)</td>
<td align="left">aet_trend</td>
<td align="right">0.0017</td>
<td align="right">0.02</td>
<td align="right">0.04</td>
</tr>
<tr class="even">
<td align="right">0.0196674</td>
<td align="left">bbs(tm_resid)</td>
<td align="left">tm_resid</td>
<td align="right">0.0015</td>
<td align="right">0.01</td>
<td align="right">0.01</td>
</tr>
<tr class="odd">
<td align="right">0.0017870</td>
<td align="left">bbs(pr_resid)</td>
<td align="left">pr_resid</td>
<td align="right">0.0004</td>
<td align="right">0.00</td>
<td align="right">0.00</td>
</tr>
<tr class="even">
<td align="right">0.0000000</td>
<td align="left">bbs(ndvi_trend)</td>
<td align="left">ndvi_trend</td>
<td align="right">0.0000</td>
<td align="right">0.00</td>
<td align="right">0.00</td>
</tr>
</tbody>
</table></div>
</div>
</div>
</div>
<div id="partialmarginal-effects" class="section level4">
<h4>
<span class="header-section-number">6.4.3.3</span> Partial/Marginal Effects<a class="anchor" aria-label="anchor" href="#partialmarginal-effects"><i class="fas fa-link"></i></a>
</h4>
<p>And, finally, we can have a look at the modelled effects of predictors on long-term assemblage trends. We first compare the output of the original models.</p>
<p>Because the full model included interaction terms, and by default the partial dependence plots are calculated by evaluating the estimated value over every unique value of the two involved variables, this can get extremely computationally intensive. So instead, we use a tweaked version of the <code>mboost.plot</code> function, which lets use set a <code>gridsize</code>, the number of values over which the partial dependence is evaluated on a quantile grid. See the <code>R/mboost_plot_grid.R</code> file for details.</p>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">'~/envirpred/R/mboost_plot_grid.R'</span><span class="op">)</span></code></pre></div>
<div id="partial-effects-rac-models" class="section level5">
<h5>
<span class="header-section-number">6.4.3.3.1</span> Partial effects RAC models<a class="anchor" aria-label="anchor" href="#partial-effects-rac-models"><i class="fas fa-link"></i></a>
</h5>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">mod_trends_rac</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="06.Model-assemblage-trends_files/figure-html/partial_effects_simple_rac-1.png" width="100%"></div>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">mod_trends_rac</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">mod_resids_rac</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="06.Model-assemblage-trends_files/figure-html/partial_effects_simple_rac-2.png" width="100%"></div>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">mod_resids_rac</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">plot_all</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">gridsize</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/model.frame.html">model.frame</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">)</span>
  <span class="va">single</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu">str_starts</span><span class="op">(</span><span class="va">preds</span>, <span class="st">"bbs"</span><span class="op">)</span><span class="op">)</span>
  <span class="va">interx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu">str_starts</span><span class="op">(</span><span class="va">preds</span>, <span class="st">"bspatial"</span><span class="op">)</span><span class="op">)</span>
  
  <span class="kw">for</span> <span class="op">(</span><span class="va">id</span> <span class="kw">in</span> <span class="va">single</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">w</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/case.names.html">variable.names</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="va">preds</span><span class="op">[</span><span class="va">id</span><span class="op">]</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">model</span>, which <span class="op">=</span> <span class="va">w</span><span class="op">)</span>
  <span class="op">}</span>
  
  <span class="kw">for</span> <span class="op">(</span><span class="va">id</span> <span class="kw">in</span> <span class="va">interx</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">w</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/case.names.html">variable.names</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="va">preds</span><span class="op">[</span><span class="va">id</span><span class="op">]</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu">plot.mboost_grid</span><span class="op">(</span><span class="va">model</span>, which <span class="op">=</span> <span class="va">w</span>, gridsize <span class="op">=</span> <span class="va">gridsize</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span>  
<span class="op">}</span>
<span class="fu">plot_all</span><span class="op">(</span><span class="va">mod_all_rac</span>, <span class="fl">200</span><span class="op">)</span></code></pre></div>
<p><img src="06.Model-assemblage-trends_files/figure-html/partial_effects_simple_rac_all-1.png" width="100%"><img src="06.Model-assemblage-trends_files/figure-html/partial_effects_simple_rac_all-2.png" width="100%"><img src="06.Model-assemblage-trends_files/figure-html/partial_effects_simple_rac_all-3.png" width="100%"><img src="06.Model-assemblage-trends_files/figure-html/partial_effects_simple_rac_all-4.png" width="100%"><img src="06.Model-assemblage-trends_files/figure-html/partial_effects_simple_rac_all-5.png" width="100%"><img src="06.Model-assemblage-trends_files/figure-html/partial_effects_simple_rac_all-6.png" width="100%"><img src="06.Model-assemblage-trends_files/figure-html/partial_effects_simple_rac_all-7.png" width="100%"><img src="06.Model-assemblage-trends_files/figure-html/partial_effects_simple_rac_all-8.png" width="100%"><img src="06.Model-assemblage-trends_files/figure-html/partial_effects_simple_rac_all-9.png" width="100%"><img src="06.Model-assemblage-trends_files/figure-html/partial_effects_simple_rac_all-10.png" width="100%"><img src="06.Model-assemblage-trends_files/figure-html/partial_effects_simple_rac_all-11.png" width="100%"><img src="06.Model-assemblage-trends_files/figure-html/partial_effects_simple_rac_all-12.png" width="100%"><img src="06.Model-assemblage-trends_files/figure-html/partial_effects_simple_rac_all-13.png" width="100%"><img src="06.Model-assemblage-trends_files/figure-html/partial_effects_simple_rac_all-14.png" width="100%"><img src="06.Model-assemblage-trends_files/figure-html/partial_effects_simple_rac_all-15.png" width="100%"></p>
<p>And because we focus specifically on temperature, let’s prettify that plot a bit.</p>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/model.frame.html">model.frame</a></span><span class="op">(</span><span class="va">mod_all_rac</span><span class="op">)</span><span class="op">)</span>
  <span class="va">single</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu">str_starts</span><span class="op">(</span><span class="va">preds</span>, <span class="st">"bbs"</span><span class="op">)</span><span class="op">)</span>
  <span class="va">interx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu">str_starts</span><span class="op">(</span><span class="va">preds</span>, <span class="st">"bspatial"</span><span class="op">)</span><span class="op">)</span>
<span class="va">w</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/case.names.html">variable.names</a></span><span class="op">(</span><span class="va">mod_all_rac</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="va">preds</span><span class="op">[</span><span class="fl">14</span><span class="op">]</span><span class="op">)</span>
<span class="va">pal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html">rev</a></span><span class="op">(</span><span class="fu">RColorBrewer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html">brewer.pal</a></span><span class="op">(</span><span class="st">'RdBu'</span>, n<span class="op">=</span><span class="fl">11</span><span class="op">)</span><span class="op">)</span>
<span class="va">theme</span> <span class="op">&lt;-</span> <span class="fu">rasterTheme</span><span class="op">(</span>region <span class="op">=</span> <span class="va">pal</span><span class="op">)</span>
<span class="fu">plot.mboost_grid</span><span class="op">(</span><span class="va">mod_all_rac</span>, which <span class="op">=</span> <span class="va">w</span>, gridsize <span class="op">=</span> <span class="fl">200</span>, at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="op">-</span><span class="fl">40</span>, to <span class="op">=</span> <span class="fl">40</span>, by <span class="op">=</span> <span class="fl">2.5</span><span class="op">)</span>,
                 xlab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="st">"Temp. trend [0.1"</span><span class="op">~</span><span class="va">degree</span><span class="op">*</span><span class="va">C</span><span class="op">~</span><span class="va">y</span><span class="op">^</span><span class="op">-</span><span class="fl">1</span><span class="op">*</span><span class="st">"]"</span><span class="op">)</span>, 
                 ylab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="st">"Temp. variability [0.1"</span><span class="op">~</span><span class="va">degree</span><span class="op">*</span><span class="va">C</span><span class="op">*</span><span class="st">"]"</span><span class="op">)</span>, 
                 par.settings <span class="op">=</span> <span class="va">theme</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="06.Model-assemblage-trends_files/figure-html/temperature_interaction_levelplot-1.png" width="100%"></div>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">mod_all_rac</span><span class="op">)</span></code></pre></div>

</div>
</div>
</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="environmental-predictability-trends.html"><span class="header-section-number">5</span> Environmental predictability &amp; trends</a></div>
<div class="next"><a href="quantify-model-uncertainty.html"><span class="header-section-number">7</span> Quantify model uncertainty</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#model-assemblage-trends"><span class="header-section-number">6</span> Model assemblage trends</a></li>
<li>
<a class="nav-link" href="#correlation-among-predictors"><span class="header-section-number">6.1</span> Correlation among predictors</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#pearsons-correlation-matrix"><span class="header-section-number">6.1.1</span> Pearson’s correlation matrix</a></li></ul>
</li>
<li><a class="nav-link" href="#pairplot"><span class="header-section-number">6.2</span> Pairplot</a></li>
<li><a class="nav-link" href="#optimal-dataset-size"><span class="header-section-number">6.3</span> Optimal dataset size</a></li>
<li>
<a class="nav-link" href="#modeling-assemblage-trends"><span class="header-section-number">6.4</span> Modeling assemblage trends</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#data-filtering"><span class="header-section-number">6.4.1</span> Data filtering</a></li>
<li><a class="nav-link" href="#training-boosted-gams"><span class="header-section-number">6.4.2</span> Training boosted GAMs</a></li>
<li><a class="nav-link" href="#model-outputs"><span class="header-section-number">6.4.3</span> Model outputs</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/barthoekstra/envirpred/blob/master/06.Model-assemblage-trends.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/barthoekstra/envirpred/edit/master/06.Model-assemblage-trends.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Environmental predictability &amp; Population trends</strong>: Linking environmental predictability to assemblage population trends of Afro-Palearctic migrants" was written by Bart Hoekstra. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>
