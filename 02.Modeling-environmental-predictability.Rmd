# Distribution maps of birds

## Converting the ESRI Geodatabase

We use the [BirdLife species distribution maps](http://datazone.birdlife.org/species/requestdis) to determine the extents of our analyses. As this data is provided in an ESRI File Geodatabase that is somehow difficult to query due to its size, we convert it to a Geopackage first.

```{r}
library(gdalUtils)
library(tidyverse)
library(fasterize)
library(raster)
library(stars)
library(sf)
library(ggpointdensity)
```

```{r convert_geodatabase_to_geopackage, eval=FALSE, include=TRUE}
ogr2ogr("data/birdlife/BOTW.gdb", "data/birdlife/BOTW.gpkg", f = "GPKG", nlt = "MULTIPOLYGON", sql = "SELECT * FROM All_Species", progress = TRUE)
```
## Loading species trends

We will use two different datasets of species trends:

1. The trends derived from PECBMS, the Pan-European Common Bird Monitoring Scheme, which contains trends for 170 European breeding birds.
1. The trends included in supplementary material of Beresford et al. (2019)

```{r load_trend_datasets}
colnames_beresford <- c("b_species", "b_hab_artificial", "b_hab_forest", "b_hab_grassland", "b_hav_savanna", 
                        "b_hab_shrubland", "b_hab_wetland", "b_trend_long", "b_trend_short")
coltypes_beresford <- "cnnnnnnnn"
species_beresford <- read_delim("data/beresfordetal2019/species.csv", delim = ";", 
                                col_names = colnames_beresford, col_types = coltypes_beresford, skip = 1)

colnames_pecbms <- c("p_euring", "p_species", "p_namenote", "p_trend_long", "p_trend_short", "p_trend_long_slope",
                     "p_trend_long_se", "p_trend_short_slope", "p_trend_short_se", "p_habitat", "p_common_name",
                     "p_trend_classification", "p_graphnote")
coltypes_pecbms <- "ncnnnnnnncccc"

species_pecbms <- read_delim("data/pecbms/pecbms-europe-indicesandtrends-2019.csv", delim = ";", 
                             col_names = colnames_pecbms, col_types = coltypes_pecbms, skip = 1)

species_pecbms %>%
  left_join(species_beresford, by = c("p_species" = "b_species")) %>%
  rename(species = p_species) -> species
```

## Querying distribution maps

Now that we have gathered the species trends, we can query the database to select corresponding distribution maps. As some species distributions span massive areas, we already select only these species distributions that intersect with the bounding box of Africa.

```{r query_geodatabase, eval=FALSE}
species_query <- str_sub(str_replace_all(toString(paste0("SCINAME = '", species$species, "' OR ")), " OR , ", " OR "),
                         start = 1, end = -5)
query <- paste("SELECT * FROM All_Species WHERE (", species_query, ") AND PRESENCE = 1 AND SEASONAL = 3", sep = "")

africa <- st_read("data/Africa-Dissolved.gpkg")

ogr2ogr("data/birdlife/BOTW.gpkg", "data/TrendSpecies.gpkg", sql = query, f = "GPKG", nlt = "MULTIPOLYGON", progress = TRUE,
        spat = st_bbox(africa))
```
```{r}
st_read("data/TrendSpecies.gpkg") %>%
  group_by(SCINAME) %>%
  summarise(species = SCINAME, geometry = st_union(st_buffer(geom, dist = 0))) %>%
  distinct(species) %>%
  left_join(species, by = c("species" = "species")) %>%
  identity() -> trendspecies
saveRDS(trendspecies, file = "data/trendspecies.RDS")
```

```{r}
trendspecies <- readRDS("data/trendspecies.RDS")
trend_long_raster <- list()
trend_short_raster <- list()

r <- raster::raster("data/gee/ndvi_1.tif")

for (i in 1:nrow(trendspecies)) {
  trend_long_raster[[i]] <- fasterize(trendspecies[i, ], raster = r, field = "p_trend_long")
  trend_short_raster[[i]] <- fasterize(trendspecies[i, ], raster = r, field = "p_trend_short")
}

trend_long_raster <- brick(trend_long_raster)
trend_short_raster <- brick(trend_short_raster)
names(trend_long_raster) <- trendspecies[, "species"]$species
names(trend_short_raster) <- trendspecies[, "species"]$species
trend_long_mean <- calc(trend_long_raster, mean, na.rm = TRUE)
trend_short_mean <- calc(trend_short_raster, mean, na.rm = TRUE)
writeRaster(trend_long_mean, file = "data/trend_long_mean.tif", overwrite = TRUE)
writeRaster(trend_short_mean, file = "data/trend_short_mean.tif", overwrite = TRUE)
```

```{r}
africa <- st_read("data/Africa-Dissolved.gpkg")
ndvi <- read_stars("data/gee/ndvi_1.tif")[,,,2]
pr <- read_stars("data/gee/pr_1.tif")[,,,2]
tmmn <- read_stars("data/gee/tmmn_1.tif")[,,,2]
tmmx <- read_stars("data/gee/tmmx_1.tif")[,,,2]
aet <- read_stars("data/gee/aet_1.tif")[,,,2]
trend_brick <- brick(c(trend_long_mean, trend_short_mean))
names(trend_brick) <- c("long", "short")
brick <- c(ndvi, pr, tmmn, tmmx, aet, st_as_stars(trend_brick), along = 3)

brick <- brick[africa]
saveRDS(brick, file = "data/brick2.RDS")
```

```{r}
brick <- readRDS("data/brick2.RDS")

data <- data.frame(ndvi = as.vector(brick[,,,1][[1]]),
                   pr = as.vector(brick[,,,2][[1]]),
                   tmmn = as.vector(brick[,,,3][[1]]),
                   tmmx = as.vector(brick[,,,4][[1]]),
                   aet = as.vector(brick[,,,5][[1]]),
                   trend_long = as.vector(brick[,,,6][[1]]),
                   trend_short = as.vector(brick[,,,7][[1]]),
                   x = st_coordinates(brick[,,,1])[, "x"],
                   y = st_coordinates(brick[,,,1])[, "y"]) %>%
  drop_na()
```

```{r}
# brick <- readRDS("data/brick.RDS")
# 
# data <- data.frame(ndvi = as.vector(brick[,,,1][[1]]),
#                    resid = as.vector(brick[,,,2][[1]]),
#                    trend = as.vector(brick[,,,7][[1]]),
#                    phase = as.vector(brick[,,,4][[1]]),
#                    phase_cor = as.vector(brick[,,,4][[1]]),
#                    trend_long = as.vector(brick[,,,8][[1]]),
#                    trend_short = as.vector(brick[,,,9][[1]]),
#                    x = st_coordinates(brick[,,,1])[, "x"],
#                    y = st_coordinates(brick[,,,1])[, "y"]) %>%
#   drop_na()
```

```{r}
data %>%
  slice_sample(prop = 0.1) %>%
  pivot_longer(cols = -c(trend_long, trend_short), names_to = "variable") %>%
  ggplot(aes(x = value, y = trend_long)) +
  geom_pointdensity() +
  geom_smooth() +
  scale_color_viridis_c(option = "viridis") +
  facet_wrap(vars(variable), scales = "free")
```

```{r}
data %>% 
  slice_sample(n = 50000) -> d

m1 <- gam(trend_long ~ s(aet) + s(ndvi) + s(pr) + s(tmmn) + s(tmmx), data = d)
summary(m1)
plot(m1, rug = TRUE)
```

```{r}
data %>%
  slice_sample(n = 20000) -> d2

m2 <- mboost(trend_long ~ bbs(aet) + bbs(ndvi) + bbs(pr) + bbs(tmmn) + bbs(tmmx) + bspatial(x, y), data = d2, control = boost_control(mstop = 10000, trace = TRUE))
```

```{r}
out <- NULL

speciesnames <- trendspecies$species
missingspecies <- c()

for (i in 1:nrow(trendspecies)) {
  area <- trendspecies[i, ]
  values <- na.omit(as.vector(brick[area][,,,2][[1]]))
  print(length(values))
  if (length(values) < 1000) {
    missingspecies[i] <- trendspecies[i, t]$species
    next
  }
  
  result <- sample(values, mlength)
  out <- cbind(out, result)
}

out <- as.data.frame(out)
names(out) <- trendspecies$species[!trendspecies$species %in% missingspecies]
```

```{r}
out %>%
  pivot_longer(cols = everything(), names_to = "species", values_to = "RMSE") %>%
  left_join(dplyr::select(species, species, p_trend_long, p_trend_short), by = c("species" = "species")) %>%
  arrange(desc(p_trend_long)) %>%
  mutate(rank = dense_rank(desc(p_trend_long))) %>%
  group_by(species) %>%
  summarise(mean_rmse = mean(RMSE, na.rm = TRUE), mean_rank = mean(rank)) %>%
  ungroup() %>%
  ggplot(aes(x = mean_rmse, y = mean_rank)) +
  # ggplot(aes(x = RMSE, y = factor(rank), fill = p_trend_long)) +
  # geom_density_ridges() +
  geom_point() +
  # geom_boxplot(outlier.shape = NA) +
  geom_smooth(method = "lm") %>%
  # stat_summary(aes(x = RMSE, y = factor(rank)), fun = median, geom = "line") +
  # scale_y_discrete(labels = species, breaks = rank) +
  # scale_fill_continuous(type = "viridis", breaks = seq(-100, 100, 200), limits = c(-100, 100))%>%
  identity()
```

```{r}
out %>%
  pivot_longer(cols = everything(), names_to = "species", values_to = "RMSE") %>%
  left_join(dplyr::select(species, species, p_trend_long, p_trend_short, p_habitat), by = c("species" = "species")) %>%
  arrange(desc(p_trend_long)) %>%
  mutate(rank = dense_rank(desc(p_trend_long))) %>%
  rowwise() %>%
  mutate(fam = str_split(species, " ")[[1]][1], sp = str_split(species, " ")[[1]][2]) %>%
  ungroup() %>%
  # separate(species, c("family", "species"), "\\s") %>%
  # filter(grepl("Anthus", species)) %>%
  # # group_by(species) %>%
  # # summarise(mean_rmse = mean(RMSE, na.rm = TRUE), mean_rank = mean(rank)) %>%
  # # ungroup() %>%
  # # ggplot(aes(x = mean_rmse, y = mean_rank)) +
  ggplot(aes(x = RMSE, y = factor(rank), fill = p_trend_long)) +
  # geom_density_ridges() +
  # geom_point() +
  geom_boxplot(outlier.shape = NA) +
  # geom_smooth() %>%
  # stat_summary(aes(x = RMSE, y = factor(rank)), fun = median, geom = "line") +
  scale_y_discrete(breaks = rank) +
  scale_fill_continuous(type = "viridis", limits = c(-100, 100), oob = scales::squish) +
  facet_wrap(vars(fam), scales = "free_y") %>%
  # coord_cartesian(xlim = c(0, 0.15)) %>%
  identity()
```

```{r}
out %>%
  pivot_longer(cols = everything(), names_to = "species", values_to = "RMSE") %>%
  left_join(dplyr::select(species, species, p_trend_long, p_trend_short), by = c("species" = "species")) %>%
  arrange(desc(p_trend_long)) %>%
  mutate(rank = dense_rank(desc(p_trend_long))) %>%
  identity() -> o
```


```{r}
plot(m2)
```
```{r}
plot(varimp(m2))
```

```{r}
st_read("data/TrendSpecies.gpkg") %>%
  group_by(SCINAME) %>%
  summarise(species = SCINAME, geometry = st_union(st_buffer(geom, dist = 0)))
```

```{r}
trendspecies_africa %>%
  filter(PRESENCE == 1, SEASONAL == 3) %>%
  group_by(SCINAME) %>%
  summarise(species = SCINAME, geometry = st_union(st_buffer(geom, dist = 0))) %>%
  distinct(species) %>%
  left_join(species, by = c("species" = "species")) %>%
  identity() -> trendspecies
saveRDS(trendspecies, file = "data/trendspecies.RDS")
```





```{r}
trendspecies %>%
  filter(PRESENCE == 1, SEASONAL == 3) %>%
  group_by(SCINAME) %>%
  summarise(species = SCINAME, geometry = st_union(st_buffer(geom, dist = 0))) %>%
  distinct(species) %>%
  left_join(species, by = c("species" = "species")) %>%
  identity() -> trendspeciesmaps
```